# Lock Protocol - ã‚¿ã‚¹ã‚¯ãƒ­ãƒƒã‚¯ã®å–å¾—ãƒ»è§£æ”¾æ‰‹é †

## ç›®çš„

è¤‡æ•°ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåŒã˜ã‚¿ã‚¹ã‚¯ã‚’åŒæ™‚ã«ä½œæ¥­ã™ã‚‹ã“ã¨ã‚’é˜²ããŸã‚ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒ­ãƒƒã‚¯æ©Ÿæ§‹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

## ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®å‘½åè¦å‰‡

```
locks/{category}__{task_id}.lock
```

**ä¾‹**:
- `locks/features__001_user_auth.lock`
- `locks/bugs__042_sql_injection.lock`
- `locks/refactor__005_dry_auth.lock`

**å‘½åãƒ«ãƒ¼ãƒ«**:
- ã‚«ãƒ†ã‚´ãƒªã¨ã‚¿ã‚¹ã‚¯IDã‚’ `__` (ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢2ã¤) ã§åŒºåˆ‡ã‚‹
- ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ `.md` ã‚’é™¤ã„ãŸéƒ¨åˆ†ã‚’ä½¿ç”¨
- `tasks/features/001_user_auth.md` â†’ `features__001_user_auth.lock`

## ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹

```
agent: {role}-{id}
started: {ISO 8601å½¢å¼ã®æ—¥æ™‚}
task: {ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ç›¸å¯¾ãƒ‘ã‚¹}
```

**ä¾‹**:
```
agent: feature-builder-A
started: 2026-02-11T10:30:00+09:00
task: tasks/features/001_user_auth.md
```

## ãƒ­ãƒƒã‚¯å–å¾—ã®æ‰‹é †

### 1. ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚€

```bash
cat tasks/features/001_user_auth.md
```

- ã‚¿ã‚¹ã‚¯ã®å†…å®¹ã‚’ç†è§£ã™ã‚‹
- `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: open` ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
- å®Œäº†æ¡ä»¶ã‚’ç¢ºèª

### 2. ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

```bash
cat > locks/features__001_user_auth.lock <<EOF
agent: feature-builder-A
started: $(date -Iseconds)
task: tasks/features/001_user_auth.md
EOF
```

### 3. ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥

```bash
git add locks/features__001_user_auth.lock
git commit -m "[feature-builder-A] lock: tasks/features/001_user_auth.md"
git pull --rebase
git push
```

**é‡è¦**: `git push` ãŒæˆåŠŸã—ãŸæ™‚ç‚¹ã§ãƒ­ãƒƒã‚¯å–å¾—å®Œäº†ã§ã™ã€‚

### 4. ãƒ­ãƒƒã‚¯å–å¾—ã®æˆåŠŸ/å¤±æ•—

#### æˆåŠŸ: push ãŒé€šã£ãŸå ´åˆ
- ãƒ­ãƒƒã‚¯å–å¾—æˆåŠŸ
- ã‚¿ã‚¹ã‚¯ã®ä½œæ¥­ã‚’é–‹å§‹ã§ãã‚‹

#### å¤±æ•—: push ã§ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒç™ºç”Ÿã—ãŸå ´åˆ
- ä»–ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå…ˆã«ãƒ­ãƒƒã‚¯ã‚’å–å¾—ã—ã¦ã„ã‚‹
- ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è§£æ¶ˆã›ãšã€åˆ¥ã®ã‚¿ã‚¹ã‚¯ã‚’é¸ã¶

```bash
# ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒç™ºç”Ÿã—ãŸå ´åˆ
git rebase --abort
git reset --hard HEAD~1

# åˆ¥ã®ã‚¿ã‚¹ã‚¯ã‚’é¸ã‚“ã§å†è©¦è¡Œ
```

## ãƒ­ãƒƒã‚¯è§£æ”¾ã®æ‰‹é †

### 1. ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ç§»å‹•

```bash
# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ done ã«å¤‰æ›´ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«å†…ï¼‰
# tasks/features/001_user_auth.md ã® `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: open` ã‚’ `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: done` ã«å¤‰æ›´

git mv tasks/features/001_user_auth.md done/features/001_user_auth.md
```

### 2. ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤

```bash
rm locks/features__001_user_auth.lock
```

### 3. ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥

```bash
git add -A
git commit -m "[feature-builder-A] complete: feat-001 ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼å®Ÿè£…å®Œäº†"
git pull --rebase
git push
```

## ãƒ­ãƒƒã‚¯ä¸­ã®è²¬å‹™

ãƒ­ãƒƒã‚¯ã‚’å–å¾—ã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ä»¥ä¸‹ã®è²¬å‹™ãŒã‚ã‚Šã¾ã™ï¼š

### 1. é©åˆ‡ãªä½œæ¥­æ™‚é–“

- ãƒ­ãƒƒã‚¯å–å¾—ã‹ã‚‰è§£æ”¾ã¾ã§ã¯ã€é€šå¸¸ **30åˆ†ä»¥å†…** ã‚’ç›®å®‰ã¨ã™ã‚‹
- é•·æ™‚é–“ãƒ­ãƒƒã‚¯ã™ã‚‹ã¨ã€ä»–ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚¿ã‚¹ã‚¯ã‚’é¸ã¹ãªããªã‚‹

### 2. ãƒ­ãƒƒã‚¯ã®å¿…é ˆè§£æ”¾

- ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ãŸã‚‰ã€å¿…ãšãƒ­ãƒƒã‚¯ã‚’è§£æ”¾ã™ã‚‹
- ã‚¨ãƒ©ãƒ¼ã§ä¸­æ–­ã™ã‚‹å ´åˆã‚‚ã€ãƒ­ãƒƒã‚¯ã‚’è§£æ”¾ã™ã‚‹

### 3. ãƒ­ãƒƒã‚¯ã®æ”¾æ£„ï¼ˆã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã§ããªã„å ´åˆï¼‰

ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã§ããªã„å ´åˆï¼ˆè¦ä»¶ä¸æ˜ã€ãƒ–ãƒ­ãƒƒã‚¯ãªã©ï¼‰ï¼š

```bash
# ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ blocked ã«å¤‰æ›´
# ç†ç”±ã‚’è¨˜éŒ²

git add tasks/features/001_user_auth.md
git commit -m "[feature-builder-A] blocked: feat-001 è¦ä»¶ä¸æ˜ã®ãŸã‚ä¿ç•™"

# ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
rm locks/features__001_user_auth.lock
git add locks/features__001_user_auth.lock
git commit -m "[feature-builder-A] unlock: feat-001"
git pull --rebase
git push
```

## ãƒ­ãƒƒã‚¯ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

### é•·æ™‚é–“ãƒ­ãƒƒã‚¯ã®æ¤œå‡º

`scripts/status.sh` ã§é•·æ™‚é–“ãƒ­ãƒƒã‚¯ä¸­ã®ã‚¿ã‚¹ã‚¯ã‚’ç¢ºèªã§ãã¾ã™ï¼š

```bash
./scripts/status.sh
```

å‡ºåŠ›ä¾‹:
```
â–  ãƒ­ãƒƒã‚¯ä¸­ã®ã‚¿ã‚¹ã‚¯
  ğŸ”’ features__001_user_auth
     æ‹…å½“: feature-builder-A  é–‹å§‹: 2026-02-11T10:00:00+09:00
     çµŒéæ™‚é–“: 2æ™‚é–“30åˆ† âš ï¸ é•·æ™‚é–“ãƒ­ãƒƒã‚¯ä¸­
```

### äººé–“ã«ã‚ˆã‚‹ä»‹å…¥

- 1æ™‚é–“ä»¥ä¸Šãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã¯ã€äººé–“ãŒç¢ºèªã™ã‚‹
- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåœæ­¢ã—ã¦ã„ã‚‹å ´åˆã¯ã€ãƒ­ãƒƒã‚¯ã‚’æ‰‹å‹•ã§å‰Šé™¤

```bash
# äººé–“ãŒæ‰‹å‹•ã§ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤
rm locks/features__001_user_auth.lock
git add locks/features__001_user_auth.lock
git commit -m "Manual unlock: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåœæ­¢ã®ãŸã‚"
git push
```

## ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ¶ˆã®ãƒ«ãƒ¼ãƒ«

### åŸå‰‡: å¾Œã‹ã‚‰æ¥ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå¼•ãä¸‹ãŒã‚‹

```bash
# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆA: å…ˆã«pushæˆåŠŸï¼ˆãƒ­ãƒƒã‚¯å–å¾—æˆåŠŸï¼‰
git push
# â†’ æˆåŠŸ

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆB: pushã§ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆï¼ˆãƒ­ãƒƒã‚¯å–å¾—å¤±æ•—ï¼‰
git push
# â†’ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆï¼

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆB: å¼•ãä¸‹ãŒã‚‹
git rebase --abort
git reset --hard HEAD~1
# â†’ åˆ¥ã®ã‚¿ã‚¹ã‚¯ã‚’é¸ã¶
```

### çµ¶å¯¾ã«ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨

- ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è§£æ¶ˆã—ã¦å¼·åˆ¶çš„ã«ãƒ­ãƒƒã‚¯ã‚’å–å¾—ã™ã‚‹
- ä»–ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã™ã‚‹
- `--force` ã‚’ä½¿ã£ã¦pushã™ã‚‹

ã“ã‚Œã‚‰ã®è¡Œç‚ºã¯ã€ä¸¦åˆ—ä½œæ¥­ã®ä»•çµ„ã¿ã‚’å£Šã—ã¾ã™ã€‚

## ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ç®¡ç†

### Gitç®¡ç†

- ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã¯ **Gitç®¡ç†å¯¾è±¡**
- `.gitignore` ã§ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ã—ãªã„

ç†ç”±: Gitã‚’é€šã˜ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã§ãƒ­ãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚

### ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª

```bash
# ç¾åœ¨ãƒ­ãƒƒã‚¯ä¸­ã®ã‚¿ã‚¹ã‚¯ä¸€è¦§
ls -lh locks/

# ç‰¹å®šã®ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹
cat locks/features__001_user_auth.lock
```

## ã‚ˆãã‚ã‚‹è³ªå•

### Q1. ãƒ­ãƒƒã‚¯ã‚’å–å¾—ã—ãŸãŒã€ã‚¿ã‚¹ã‚¯ãŒå¤§ãã™ãã¦æ™‚é–“ãŒã‹ã‹ã‚Šãã†

A. ä»¥ä¸‹ã®é †ã§å¯¾å¿œï¼š
1. ã‚¿ã‚¹ã‚¯ã‚’åˆ†å‰²ã§ããªã„ã‹æ¤œè¨
2. åˆ†å‰²ã§ãã‚‹å ´åˆã¯ã€ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã‚’ç¸®å°ã—ã€æ®‹ã‚Šã‚’æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã¨ã—ã¦è¿½åŠ 
3. åˆ†å‰²ã§ããªã„å ´åˆã¯ã€ãƒ­ãƒƒã‚¯ã‚’ä¿æŒã—ãŸã¾ã¾ä½œæ¥­ã‚’ç¶šã‘ã‚‹ï¼ˆãŸã ã—ã€2æ™‚é–“ä»¥å†…ã«å®Œäº†ã•ã›ã‚‹åŠªåŠ›ã‚’ã™ã‚‹ï¼‰

### Q2. pushã«å¤±æ•—ã—ãŸãŒã€ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã§ã¯ãªã„ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãªã©ï¼‰

A. ä»¥ä¸‹ã®é †ã§å¯¾å¿œï¼š
1. å†åº¦ `git pull --rebase && git push` ã‚’è©¦è¡Œ
2. æˆåŠŸã™ã‚Œã°ãƒ­ãƒƒã‚¯å–å¾—å®Œäº†
3. å¤±æ•—ãŒç¶šãå ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦å¯¾å‡¦

### Q3. ä»–ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒ­ãƒƒã‚¯ã—ãŸã¾ã¾åœæ­¢ã—ã¦ã„ã‚‹

A. ä»¥ä¸‹ã®é †ã§å¯¾å¿œï¼š
1. ã‚ãªãŸï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰ã¯ä½•ã‚‚ã—ãªã„
2. äººé–“ãŒ `./scripts/status.sh` ã§é•·æ™‚é–“ãƒ­ãƒƒã‚¯ã‚’æ¤œå‡º
3. äººé–“ãŒæ‰‹å‹•ã§ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤

### Q4. ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—å¿˜ã‚ŒãŸ

A. ä»¥ä¸‹ã®é †ã§å¯¾å¿œï¼š
1. æ°—ã¥ã„ãŸæ™‚ç‚¹ã§ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
2. ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
3. æ¬¡å›ã‹ã‚‰æ³¨æ„ã™ã‚‹

## ã¾ã¨ã‚

- **ãƒ­ãƒƒã‚¯å–å¾— = git push ãŒæˆåŠŸã—ãŸæ™‚ç‚¹**
- **ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆ = ãƒ­ãƒƒã‚¯å–å¾—å¤±æ•— â†’ åˆ¥ã®ã‚¿ã‚¹ã‚¯ã‚’é¸ã¶**
- **ãƒ­ãƒƒã‚¯è§£æ”¾ = ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã¾ãŸã¯ã‚¿ã‚¹ã‚¯æ”¾æ£„æ™‚**
- **é•·æ™‚é–“ãƒ­ãƒƒã‚¯ = äººé–“ãŒä»‹å…¥**

ã“ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’å®ˆã‚‹ã“ã¨ã§ã€è¤‡æ•°ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå®‰å…¨ã«ä¸¦åˆ—ä½œæ¥­ã§ãã¾ã™ã€‚
