# 作業履歴: 協調プロトコル整備（commit/lock/test）

## 壁打ちフェーズ [2026-02-25 10:00]

### 理解のサマリー
- タスクの目的: 複数 Claude エージェントが並列動作する際の commit/lock/test に関する協調プロトコルをガイドライン文書として定義する。参考 PoC の設計を分析し、本リポジトリの L1/L2 ワークフローに適した形にカスタマイズする
- スコープ: T-001〜T-007（フェーズ1 L2-worker 担当分すべて）。PoC 分析、worktree ガイドラインとの接続確認、3つのプロトコル設計、ガイドライン文書作成、課題の CSV 転記
- 完了条件: `docs/coordination-protocol-guideline.md` にガイドライン文書が作成され、`03_work_log.md` に作業履歴、`04_work_report.md` に作業レポートが記載され、`02_tasks.md` のチェックボックスが更新されていること

### 前提条件チェック
- [x] 依存タスクの完了状態: 完了（git worktree 施策が完了済み、`docs/git-worktree-guideline.md` が存在）
- [x] 必要ツール・コマンドの利用可否: 確認済み（ファイル読み書きのみ、コード変更なし）
- [x] 環境の準備状況（ファイル・ディレクトリの存在等）: 確認済み（refs/ai-driven-development-poc/ のプロトコル文書3本、initiatives/coordination-protocol/ の全テンプレートファイルが存在）

### 不明点・確認事項
なし

### L1 確認結果
確認事項なし：実施開始

---

## 実施計画サマリ

以下の順序でタスクを実施する:

1. **T-001**: `refs/ai-driven-development-poc/` の3プロトコル（lock/commit/test）を分析し、設計思想・メリット・制約を整理
2. **T-002**: `docs/git-worktree-guideline.md` のセクション6を中心に接続点を確認
3. **T-003**: commit プロトコルの設計（PoC 分析 + worktree 接続点を踏まえて）
4. **T-004**: lock プロトコルの設計
5. **T-005**: test プロトコルの設計
6. **T-006**: T-001〜T-005 の成果を統合してガイドライン文書を作成
7. **T-007**: 課題確認・CSV 転記

---

## 作業ログ

### [2026-02-25 10:05] タスクID: T-001
**状態**: 完了
**作業内容**:
- `refs/ai-driven-development-poc/.claude/protocols/` 配下の3プロトコル文書、`docs/reference.md`、`README.md` を分析
- 各プロトコルの設計思想・メリット・制約を以下に整理

#### 分析結果

##### ① 各プロトコルの目的と適用範囲

| プロトコル | 目的 | 適用範囲 |
|-----------|------|---------|
| **lock_protocol.md** | 複数エージェントの同一タスク同時作業を防止 | タスク単位の排他制御。`locks/` ディレクトリにテキストファイルを作成し Git push の成功/失敗でロック取得を判定 |
| **commit_protocol.md** | 統一されたコミットメッセージ形式による進捗の自動記録とチーム間の可読性確保 | 全エージェントのコミット操作。`[role-id] category-task_id: summary` 形式を厳守 |
| **test_protocol.md** | 統一されたテスト実行ルールによる品質保証と並列作業でのテスト失敗の早期検出 | 全エージェントのテスト実行。2段階テスト（fast/full）で効率と網羅性を両立 |

##### ② テキストファイルベースのロック方式の長所・短所

**長所:**
- シンプルで理解しやすい（テキストファイルの有無でロック状態が可視化）
- Git の push 成功/失敗を楽観的ロック判定に利用（追加インフラ不要）
- `locks/` ディレクトリを見れば「誰が何を作業中か」が一目瞭然
- `status.sh` で長時間ロックの検出が可能

**短所:**
- push コンフリクトに依存するため、ネットワーク遅延やタイミングの問題がありうる
- ロック取得失敗時は別タスクへ切り替える必要がある（待機メカニズムがない）
- エージェント停止時にロックが残留する（人間の介入が必要）
- ロックの粒度がタスク単位に固定されており、ファイル単位の細粒度ロックには対応していない

##### ③ コミットメッセージ規約とブランチ戦略

- **メッセージ形式**: `[role-id] category-task_id: summary` + 詳細説明
- **カテゴリ**: feat / bug / refactor / test / optimize / docs / lock / complete
- **ブランチ戦略**: 全エージェントが同一ブランチ（main/master）で作業する設計。ブランチ分離ではなく、ロックとコミット規約で競合を回避
- **push 前の手順**: `git pull --rebase` で履歴を直線的に保つ
- **コンフリクト解消**: ロックファイルのコンフリクトは引き下がる、ソースコードのコンフリクトは解消してテスト実行
- **禁止事項**: force push、意味のないコミットメッセージ、テスト失敗状態でのコミット

##### ④ 2段階テスト（fast/full）の仕組み

- **Fast Check** (`ci/run_fast.sh`): コミット前に必須実行。30秒以内。静的解析 + 重要ユニットテストのみ
- **Full Test** (`ci/run_full.sh`): push 前に必須実行。5分以内。全ユニットテスト + 統合テスト + カバレッジ
- **失敗時の対応**: 自分の変更が原因なら修正、既存バグなら Bug Fixer タスクとして起票して別タスクに移行
- **テストのベストプラクティス**: 独立性・再現性・高速性・明確性

##### ⑤ 本リポジトリへの適用可否（そのまま適用 vs 要カスタマイズ）

| 項目 | 判定 | 理由 |
|------|------|------|
| テキストファイルベースのロック方式 | 要カスタマイズ | 本リポジトリは文書中心で worktree による物理的隔離が利用可能。ロック対象はタスクではなくファイル/リソース単位に再設計が必要 |
| コミットメッセージ規約 | 部分適用 | `[role-id]` によるエージェント識別の考え方は有用だが、本リポジトリの L1/L2 ロール体系に合わせた形式にカスタマイズが必要 |
| ブランチ戦略（全員同一ブランチ） | 要カスタマイズ | worktree 利用時はブランチが分離されるため、マージ戦略の定義が必要。非 worktree 時（現状の順次実行）は同一ブランチでも問題ない |
| 2段階テスト | 要カスタマイズ | 概念は有用だが、本リポジトリは文書中心でコードテストが主でないため、テスト内容の定義を本リポジトリ向けに再設計が必要 |
| コンフリクト解消ルール | 部分適用 | 「後から来たエージェントが引き下がる」原則は有用。worktree 利用時のマージコンフリクト解消手順を追加定義が必要 |
| post-commit フックによる進捗自動記録 | 参考情報 | コミットフックの考え方は有用だが、現在の L1/L2 ワークフローでは `03_work_log.md` への手動記録が主のため、将来的な検討事項 |

**成果物**: 上記分析結果（本セクション）
**課題・気づき**: なし

---

### [2026-02-25 10:15] タスクID: T-002
**状態**: 完了
**作業内容**:
- `docs/git-worktree-guideline.md` のセクション6「協調プロトコル施策との接続点」を中心に全体を確認
- worktree ガイドラインとの接続点を以下に整理

#### 確認結果

##### worktree ガイドラインからの接続点一覧

| # | 接続点 | 内容 | プロトコル設計への反映方針 |
|---|--------|------|--------------------------|
| 1 | commit プロトコルとの関係 | worktree 上ではブランチが分離されるため同一ブランチへの push コンフリクトは発生しない。ただしマージ時のコミット戦略（squash / merge commit / rebase）の定義が必要 | commit プロトコルにマージ戦略のセクションを追加 |
| 2 | lock プロトコルとの関係 | worktree によりファイルレベルの排他制御は不要になる。ただし共有リソース（外部サービス、設定ファイル等）のアクセスにはロックが必要な場合がある | lock プロトコルでは worktree 利用時のロック対象を「共有リソースのみ」に限定する設計にする |
| 3 | test プロトコルとの関係 | 各 worktree で独立にテストを実行可能。ただしテスト結果の集約方法と、テスト失敗時の他エージェントへの影響範囲の定義が必要 | test プロトコルに worktree 別テスト実行と結果集約のルールを追加 |
| 4 | レイヤー分離の原則 | worktree ガイドラインは「インフラ層（物理的隔離メカニズム）」、協調プロトコルは「アプリケーション層（隔離された環境上での運用ルール）」を扱う | ガイドライン文書でレイヤー分離を明記し、worktree ガイドラインとの役割分担を明確にする |
| 5 | 段階的導入ロードマップとの整合 | ステージ1（現状維持）→ ステージ2（独立タスク並列化）→ ステージ3（高度な並列化 = worktree + 協調プロトコル）| プロトコル設計を段階的に適用可能な構造にする。ステージ1向けの最小プロトコルとステージ3向けの完全プロトコルを分けて記載 |
| 6 | 方式の補完性 | worktree 方式とロックベース方式は排他的ではなく補完的。worktree で物理的に隔離した上で、共有リソースのアクセスにロックを使うこともできる | 両方式の併用パターンを適用シナリオとして記載 |

##### worktree 利用時と非利用時の差異（各プロトコルへの影響）

| プロトコル | 非 worktree（現状の順次実行） | worktree 利用時（将来の並列実行） |
|-----------|-------------------------------|--------------------------------|
| **commit** | 同一ブランチで順次コミット。コンフリクトなし | ブランチ分離。マージ時にコンフリクト検出。マージ戦略の定義が必要 |
| **lock** | ファイル所有権ルールで暗黙的に排他。明示的ロック不要 | ファイルレベルは worktree で隔離。共有リソースのみ明示的ロックが必要 |
| **test** | 順次実行のため排他制御不要 | 各 worktree で独立実行可能。マージ前にフルテストが必要 |

**成果物**: 上記確認結果（本セクション）
**課題・気づき**: なし

---

### [2026-02-25 10:25] タスクID: T-003
**状態**: 完了
**作業内容**:
- T-001 の PoC 分析と T-002 の worktree 接続点を踏まえ、commit プロトコルを設計

#### 設計結果

##### ① コミットタイミング

| シナリオ | タイミング | 備考 |
|---------|-----------|------|
| L2-worker（順次実行、現状） | タスク完了時に一括コミット | 現在の運用に合致。小さなタスクなら1コミットで十分 |
| L2-worker（並列実行、将来） | 論理的な作業単位ごとにコミット | 変更を小さく保ち、マージコンフリクトのリスクを低減 |
| L2-evaluator | 評価レポート完成時にコミット | 評価は読み取り中心のため、コミット頻度は低い |
| L1 | 計画・タスク作成完了時にコミット | L1 の成果物は計画フェーズに集中 |

##### ② コミットメッセージ規約

PoC の `[role-id] category-task_id: summary` を本リポジトリの L1/L2 体系に適応:

```
[<session-type>] <initiative>: <summary>

<details>
```

- **session-type**: `L1` / `L2-worker` / `L2-evaluator`
- **initiative**: 施策名（initiatives/ 配下のディレクトリ名）
- **summary**: 1行の要約（50文字以内推奨）
- **details**: 変更したファイル一覧、作業内容の詳細（任意）

例:
```
[L2-worker] coordination-protocol: ガイドライン文書を作成

- docs/coordination-protocol-guideline.md を新規作成
- 03_work_log.md に作業履歴を記録
- 04_work_report.md に作業レポートを作成
```

##### ③ ブランチ戦略

| シナリオ | ブランチ戦略 | マージ方式 |
|---------|-------------|-----------|
| 順次実行（現状） | 施策ごとのフィーチャーブランチ（`claude/<施策名>-<suffix>`）で作業し main へマージ | 通常のマージコミット |
| worktree 並列実行（将来） | 各 worktree にエージェント個別ブランチ（`worktree-<名前>`）を自動作成 | squash merge を推奨（並列作業の中間コミットをクリーンにまとめる） |

##### ④ コンフリクト発生時の解消手順

1. **順次実行時**: コンフリクトは原則発生しない（ファイル所有権ルールにより同時編集がない）
2. **並列実行時（worktree）**:
   - マージ時にコンフリクトが検出された場合、L1 がコンフリクト内容を確認
   - ファイル所有権に基づき、各エージェントの変更を尊重して手動解消
   - 解消後にフルテストを実行して整合性を確認
3. **PoC 由来の原則を適用**: 同一リソースへの同時変更は「後から来たエージェントが引き下がる」（ロックベースの場合）

##### ⑤ worktree 利用時と非利用時の差異

| 項目 | 非 worktree | worktree |
|------|------------|----------|
| ブランチ | 共有フィーチャーブランチ | エージェント個別ブランチ |
| push コンフリクト | 発生しうる（同一ブランチ） | 発生しない（ブランチ分離） |
| マージコンフリクト | なし（順次実行） | マージ時に検出 |
| コミット粒度 | タスク完了時一括 | 小さな論理単位ごと推奨 |

**成果物**: 上記設計結果（本セクション）
**課題・気づき**: なし

---

### [2026-02-25 10:35] タスクID: T-004
**状態**: 完了
**作業内容**:
- lock プロトコルを設計。PoC のテキストファイルベースロックを本リポジトリ向けにカスタマイズ

#### 設計結果

##### ① 排他制御の対象

| 対象 | 具体例 | 排他制御の要否 |
|------|--------|--------------|
| 施策ファイル（L1 所有） | `00_proposal.md`, `01_plan.md`, `02_tasks.md`, `08_gate_review.md` | ファイル所有権ルールで暗黙的に排他（L1 のみ編集可） |
| 施策ファイル（L2-worker 所有） | `03_work_log.md`, `04_work_report.md` | ファイル所有権ルールで暗黙的に排他（L2-worker のみ編集可） |
| 施策ファイル（L2-evaluator 所有） | `05_eval_plan.md`, `06_eval_report.md` | ファイル所有権ルールで暗黙的に排他（L2-evaluator のみ編集可） |
| 共有ファイル | `07_issues.md`, `プロセス改善_課題管理.csv` | 複数セッションが書き込む可能性あり。並列実行時は明示的ロックが必要 |
| docs/ 配下の成果物 | ガイドライン文書等 | 通常は1タスクで1つの文書を担当。並列で同一文書を編集する場合はロックが必要 |

##### ② ロック方式

**段階的な3層のロック方式を提案:**

| 層 | 方式 | 適用シナリオ |
|----|------|-------------|
| **層1: ファイル所有権（暗黙的ロック）** | L1/L2 のファイル所有権ルール（既存） | 現在の順次実行。追加実装不要 |
| **層2: worktree による物理的隔離** | `isolation: worktree` でブランチ・ディレクトリを分離 | 将来の並列実行（独立タスク） |
| **層3: テキストファイルベースの明示的ロック** | PoC 方式を簡略化。共有リソースのみに適用 | 将来の並列実行（共有リソースアクセス時） |

**層3 のロックファイル仕様（PoC から簡略化）:**

```
ファイル名: .locks/<resource-name>.lock
内容:
  agent: <session-type>-<identifier>
  started: <ISO 8601>
  resource: <対象リソースのパス>
```

##### ③ ロックの粒度とデッドロック回避策

- **粒度**: ファイル単位（PoC のタスク単位から変更）。1ファイル = 1ロック
- **デッドロック回避**:
  - ロック取得順序を固定（ファイルパスの辞書順）
  - ロック取得はタイムアウト付き（推奨: 30秒）
  - 1エージェントが同時に保持できるロック数を制限（推奨: 最大3）
  - 長時間ロック（30分超）は自動警告、1時間超は人間が介入

##### ④ ロック取得失敗時の振る舞い

| 状況 | 振る舞い |
|------|---------|
| ロック取得失敗（他エージェントが保持中） | 即座に別タスクへ移行（PoC と同じ「引き下がる」原則） |
| ロック取得失敗（タイムアウト） | 07_issues.md にブロック状況を起票し、L1 に判断を委ねる |
| ロック保持中にエラー発生 | ロックを解放してからエラー報告 |
| エージェント異常停止 | 人間が `status.sh` 等で検出し手動解放 |

##### ⑤ 現在の L1/L2 ファイル所有権ルールとの関係

- 現在の L1/L2 ファイル所有権ルール（層1）は**そのまま維持**
- 並列実行が導入されるまでは層1のみで十分（追加のロック機構は不要）
- 並列実行導入時に層2（worktree）を優先適用し、層3（明示的ロック）は共有リソースのみに限定
- 層1 → 層2 → 層3 の順で段階的に適用することで、運用の複雑さを最小限に抑える

**成果物**: 上記設計結果（本セクション）
**課題・気づき**: なし

---

### [2026-02-25 10:45] タスクID: T-005
**状態**: 完了
**作業内容**:
- test プロトコルを設計。PoC の2段階テストを本リポジトリ向けにカスタマイズ

#### 設計結果

##### ① テスト実行のタイミング

| タイミング | テスト種別 | 必須/推奨 | 備考 |
|-----------|-----------|---------|------|
| コミット前 | Fast Check（高速チェック） | 推奨 | 現在のリポジトリでは文書中心のためテストスクリプトが整備されていない場合はスキップ可 |
| push / マージリクエスト前 | Full Test（フルテスト） | 推奨 | CI が整備されている場合は必須化を検討 |
| worktree マージ前 | Full Test | 必須（並列実行時） | マージ後の整合性を保証 |

##### ② テスト範囲

**本リポジトリのテスト対象（文書中心リポジトリ向け）:**

| テスト種別 | 内容 | 実行時間目安 |
|-----------|------|------------|
| Fast Check | YAML/Markdown の構文チェック、リンク切れ検出、ファイル命名規則チェック | 30秒以内 |
| Full Test | 上記 + ドキュメント間の整合性チェック（参照先の存在確認等）、テンプレート準拠チェック | 2分以内 |

##### ③ 並列テスト実行時の排他制御

| シナリオ | 排他の要否 | 方針 |
|---------|-----------|------|
| 各 worktree で独立にテスト実行 | 不要 | 各 worktree が独立したファイルシステムを持つため、テスト間の干渉なし |
| 共有テスト環境（外部 DB、API 等）がある場合 | 必要 | テスト用の環境変数やポートを worktree ごとに分離するか、テスト環境へのアクセスにロックを使用 |
| マージ後のフルテスト | 不要（逐次実行） | マージは L1 が制御するため、マージ後のテストは1回のみ実行 |

##### ④ テスト失敗時の振る舞い

| 失敗の種類 | 対応 |
|-----------|------|
| 自エージェントの変更が原因 | 修正してテストを再実行。修正できない場合は変更をリバートし、07_issues.md に起票 |
| 他エージェントの変更が原因（マージ後に検出） | L1 に報告し、コンフリクト解消の判断を委ねる |
| 既存のテスト不備 | 07_issues.md にテスト不備として起票し、現在のタスクは続行 |
| テスト環境の問題 | リトライ。解消しない場合は 07_issues.md に起票 |

**他エージェントへの通知:**
- 順次実行時: 他エージェントが存在しないため通知不要
- 並列実行時: テスト失敗が共有リソースに影響する場合のみ、L1 経由で他エージェントに通知

##### ⑤ 2段階テスト（fast/full）の採用可否

**採用する（段階的に）:**

| ステージ | Fast Check の内容 | Full Test の内容 | 備考 |
|---------|------------------|-----------------|------|
| ステージ1（現状） | 未整備（スキップ可） | 未整備（スキップ可） | 文書中心のため、テストスクリプトの整備は将来課題 |
| ステージ2（テスト整備後） | YAML 構文チェック、Markdown lint | + リンク切れ検出、テンプレート準拠チェック | CI パイプラインの整備と合わせて導入 |
| ステージ3（並列実行時） | 上記 + 変更ファイル関連の整合性チェック | + 全ファイルの整合性チェック、クロスリファレンス検証 | worktree マージ前の品質ゲートとして機能 |

**成果物**: 上記設計結果（本セクション）
**課題・気づき**: なし

---

### [2026-02-25 11:00] タスクID: T-006
**状態**: 完了
**作業内容**:
- T-001〜T-005 の成果を統合し、`docs/coordination-protocol-guideline.md` を作成
- 8セクション（概要、commit プロトコル、lock プロトコル、test プロトコル、相互関係、適用シナリオ、worktree ガイドラインとの関係、段階的導入の方針）を含む

**成果物**: `dev-process-improvement/docs/coordination-protocol-guideline.md`
**課題・気づき**: なし

---

### [2026-02-25 11:15] タスクID: T-007
**状態**: 完了
**作業内容**:
- `07_issues.md` の未転記課題を確認
- 本施策中に新たな課題は発見されなかったため、転記対象なし
- `07_issues.md` に「課題なし」の記録を追記

**成果物**: `07_issues.md` 更新
**課題・気づき**: なし
