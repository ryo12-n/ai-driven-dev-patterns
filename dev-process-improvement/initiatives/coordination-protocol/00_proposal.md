# 改善施策提案: 協調プロトコル整備（commit/lock/test）

## 背景・課題

複数の Claude エージェントが並列に動作する場面（L2-worker の並列化、worktree ベースの分離開発など）において、以下の協調に関するルールが未定義である。

1. **commit の協調**: 複数エージェントが同一ブランチまたは別ブランチで commit する際のタイミング・メッセージ規約・コンフリクト時の振る舞いが未定義
2. **lock の協調**: 同じファイルやリソースに対する排他制御の仕組みが未定義。参考 PoC ではテキストファイルベースのロック方式が提案されているが、本リポジトリの運用に合わせた設計は行われていない
3. **test の協調**: 並列エージェントがテストを実行する際の順序・範囲・失敗時の振る舞い（他エージェントの作業を止めるか否か等）が未定義

現状は L2 を順次起動しているため深刻な問題は発生していないが、将来の並列化拡張に備えて予防的にプロトコルを整備しておく必要がある。

## 目標

- エージェント間の commit・lock・test に関する**協調プロトコルをガイドライン文書として定義**する
- 現在の運用（順次実行）と将来の運用（並列実行）の両方に対応する設計にする
- git worktree 施策（`initiatives/git-worktree-standardization/`）の成果を前提条件として取り込む

## スコープ

### やること
- commit プロトコル（コミットタイミング・メッセージ規約・コンフリクト解消手順）の定義
- lock プロトコル（排他制御の仕組み・対象リソースの粒度・デッドロック回避策）の定義
- test プロトコル（テスト実行の順序・範囲・失敗時の振る舞い）の定義
- 参考 PoC（`refs/ai-driven-development-poc/`）の既存プロトコル設計の分析・取り込み
- ガイドライン文書（`docs/` 配下）の作成
- git worktree 施策の成果との接続・整合確認

### やらないこと
- CLAUDE.md や `.claude/rules/*.md` への組み込み（ガイドライン作成までがスコープ）
- L1/L2 ワークフローの実際の変更
- ロック機構やテスト実行スクリプトの実装
- CI/CD パイプラインの変更

## 期待される効果

- 将来の並列開発時にエージェント間の競合・整合性問題を未然に防止できる
- 協調ルールが明文化されることで、新しいエージェントロールを追加する際の設計指針になる
- worktree による隔離と協調プロトコルの組み合わせにより、安全な並列開発の基盤が整う

## リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| 予防的な設計のため、実際の運用で想定外のケースが発生する可能性 | 中 | プロトコルを段階的に適用し、実運用でのフィードバックを反映する設計にする |
| worktree 施策の結果によってプロトコル設計が大きく変わる可能性 | 中 | worktree 施策を先行させ、その成果を前提条件として取り込む |
| プロトコルが過剰に複雑になり実用性が下がるリスク | 低 | 最小限のルールから始め、段階的に拡張する方針を明記する |

## 壁打ちの背景

壁打ちフェーズで以下の意思決定を行った。

- **施策の独立性**: git worktree 施策とは別の initiative として進める。worktree はインフラ的な隔離メカニズム、本施策はその上の協調ルールであり、レイヤーが異なるため
- **進行順序**: git worktree 施策を先行させ、その成果を前提条件として本施策に取り込む
- **緊急度**: 予防的な検討であり、現時点で具体的な競合問題は発生していない。そのため調査・ガイドライン作成に留め、実装は行わない
- **成果物の深さ**: ガイドライン文書の作成まで。ルールファイルへの組み込みは将来の施策で行う

## 備考・設計パターン

本施策は調査・文書化が主であり、コード変更を伴わない。
参考 PoC の `lock_protocol.md`・`commit_protocol.md`・`test_protocol.md` を分析し、本リポジトリの運用に適した形にカスタマイズする。
git worktree 施策の成果物（`docs/git-worktree-guideline.md`）を前提条件として参照する。

---
**起票者**: L1
**起票日**: 2026-02-25
**ステータス**: 起票
