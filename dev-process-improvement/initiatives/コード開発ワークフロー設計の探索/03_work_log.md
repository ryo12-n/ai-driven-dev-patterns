# 作業履歴: コード開発ワークフロー設計の探索

## 壁打ちフェーズ [2026-03-01 10:00]

### 理解のサマリー
- タスクの目的: `roles/` 配下の既存7ロール（feature_builder, test_writer, reviewer, bug_fixer, refactorer, optimizer, documentarian）と `_base/common.md` を分析し、コード開発ワークフローの概念設計を行う。既存ロールの適合度評価、TDD方式の評価、不足ロールの特定を経て、ワークフロー全体像を設計ドキュメントとしてまとめる。
- スコープ: フェーズ1（T-001〜T-005）。概要設計レベルの探索であり、コード実装は伴わない。成果物は `docs/design/dev-workflow-overview.md` と各管理ファイルへの記録。
- 完了条件: (1) 03_work_log.md に壁打ちフェーズの記録と作業ログが記載されている (2) 04_work_report.md にフェーズ1の計画対比実績が記載されている (3) docs/design/dev-workflow-overview.md が作成されT-001〜T-004の全内容が含まれている (4) 07_issues.md の全課題に転記済み/転記不要の判断が付いている (5) 02_tasks.md のT-001〜T-005のステータスが更新されている

### 前提条件チェック
- [x] 依存タスクの完了状態: 依存なし（フェーズ1は初回タスク）
- [x] 必要ツール・コマンドの利用可否: 確認済み（ファイル読み書きのみ）
- [x] 環境の準備状況（ファイル・ディレクトリの存在等）: 確認済み（roles/ 配下の全ファイルが存在。docs/design/ ディレクトリは存在するがdev-workflow-overview.mdは未作成）

### 不明点・確認事項
なし

### L1 確認結果
確認事項なし：実施開始

---

## 実施計画サマリ

T-001〜T-005 を以下の順序で実施する。

1. **T-001**: `roles/` 配下の7ロール + `_base/common.md` を全て読み、各ロールの開発ワークフローへの適合度を分析する（全ファイル読了済み）
2. **T-002**: feature_builder と test_writer の分離TDD方式の有効性を評価する
3. **T-003**: 不足ロール（設計者、開発マネージャー等）の要件を整理する
4. **T-004**: T-001〜T-003 の分析結果を統合し、`docs/design/dev-workflow-overview.md` を作成する
5. **T-005**: `07_issues.md` の未転記課題を確認し、転記判断を付ける

T-001〜T-003 の分析は作業ログに記録し、T-004 で設計ドキュメントに統合する。

---

## 作業ログ

### [2026-03-01 10:10] タスクID: T-001
**状態**: 完了
**作業内容**:
- `roles/_base/common.md` および 7ロール全て（feature_builder, test_writer, reviewer, bug_fixer, refactorer, optimizer, documentarian）を読了
- 各ロールの責務・作業フロー・制約を整理し、開発ワークフローへの適合度を4観点で分析

**分析結果**:

#### 共通基盤（`_base/common.md`）の概要
- L1（マネージャー）→ L2（サブエージェント）のアーキテクチャを前提
- 基本ループ: タスク確認 → 実装 → テスト → コミット → 完了報告
- 1回の起動で1タスク完了。無限ループ・継続実行禁止
- ロール外作業の禁止が厳密に定義されている
- Conventional Commits スタイルのコミット規約
- タスクの発生元は現在 `02_tasks.md`（将来的に openspec 連携の可能性あり）

#### ロール別分析

##### 1. feature_builder（機能実装担当）
- **①現状の責務**: 新機能の実装。タスク確認 → 要件理解 → 実装（TDD意識）→ テスト → コミット → 報告
- **②適合度: 高** — 開発ワークフローの中心ロール。コード実装という明確な責務を持ち、TDD の意識も組み込まれている。完了条件チェックリスト駆動で作業する設計は、タスク管理との親和性が高い
- **③必要な修正点**: (a) openspec 連携の TODO が未実装。将来的に仕様参照フローの追加が必要 (b) テスト実行コマンドが未確定（TODO状態）(c) リファクタリングの「例外: 実装したコードのみの最小限の整理はOK」の範囲が曖昧
- **④依存関係**: test_writer（テストカバレッジ拡充を委譲）、bug_fixer（既存バグの修正を委譲）、refactorer（リファクタリングを委譲）、optimizer（パフォーマンス改善を委譲）、documentarian（ドキュメント更新を委譲）。最も多くのロールにタスクを起票する起点ロール

##### 2. test_writer（テスト整備担当）
- **①現状の責務**: テストカバレッジ拡充、エッジケース発見、テスト品質改善。カバレッジ確認 → 計画 → 実装 → 実行 → コミット → 報告
- **②適合度: 高** — 独立したテスト専門ロールとして設計されており、品質保証のワークフローに直接組み込める。FIRST原則・AAAパターンなど品質基準が明確
- **③必要な修正点**: (a) テスト実行コマンドが未確定（TODO状態）(b) feature_builder との連携プロトコル（どのタイミングでテストを書くか）が未定義。現状は「カバレッジ向上」の事後タスクとしてのみ定義されている (c) バグ発見時の failing test コミットフローが特殊（修正せずコミットする）で、CI との整合性に注意が必要
- **④依存関係**: feature_builder から「カバレッジ向上テスト追加」タスクを受ける。bug_fixer へバグ発見を起票する。refactorer へ「テスト可能なように設計改善」を起票する可能性あり

##### 3. reviewer（レビュー担当）
- **①現状の責務**: 直近コミットの静的レビュー。問題発見・分類・タスク起票のみ。自分では修正しない
- **②適合度: 高** — 品質ゲートとしてワークフローに不可欠。セキュリティ・バグリスク・設計・パフォーマンス・可読性の5観点と Critical/High/Medium/Low の4段階分類が体系的。発見した問題を適切なロールへ振り分ける仕組みが明確
- **③必要な修正点**: (a) openspec 連携の TODO が未実装（仕様との整合性チェック）(b) レビュー対象の指定方法が「直近N件のコミット」に限定されており、PR単位やファイル単位のレビュー指示に対応していない (c) L1 への報告と、他ロールへのタスク起票の具体的な配置先が未定義
- **④依存関係**: 全ロール（feature_builder, bug_fixer, refactorer, optimizer）の成果物をレビューする。bug_fixer, refactorer, optimizer へタスクを起票する。ワークフロー上のゲートキーパー的位置づけ

##### 4. bug_fixer（バグ修正担当）
- **①現状の責務**: 失敗テスト・既知バグの修正。バグ再現 → 原因分析 → 最小差分修正 → 回帰テスト追加 → コミット → 報告
- **②適合度: 高** — 「再現テスト作成 → 原因特定 → 最小差分修正 → 回帰テスト」のフローが体系的。最小差分原則が明確で、スコープ制御がしやすい
- **③必要な修正点**: (a) テスト実行コマンドが未確定（TODO状態）(b) バグ報告の受け取り方（タスクファイルの形式・配置先）が未定義 (c) 「大規模修正が必要な場合は Refactorer に起票」のエスカレーション基準が定量的でない
- **④依存関係**: reviewer, test_writer, feature_builder からバグ報告を受ける。refactorer へ「根本的な設計改善が必要」な場合に起票する

##### 5. refactorer（リファクタリング担当）
- **①現状の責務**: 重複コード統合・設計改善・DRY化。振る舞いを変えないことが絶対条件。小さなステップで変更し、各ステップでテスト実行
- **②適合度: 中** — ワークフローでの位置づけがやや曖昧。独立したタスクとして起動されるが、「いつリファクタリングを実施するか」のトリガー条件が不明確。他ロール（reviewer, feature_builder）からの起票駆動でしか動かない
- **③必要な修正点**: (a) テスト実行コマンドが未確定（TODO状態）(b) ワークフロー内での発動タイミング（コードレビュー後？機能実装後？定期的？）の定義が必要 (c) テストがない対象コードへのリファクタリング時の安全ネット確保手順が弱い
- **④依存関係**: reviewer, feature_builder, test_writer からリファクタリングタスクを受ける。test_writer へ「テストが足りない」場合に起票する可能性あり

##### 6. optimizer（最適化担当）
- **①現状の責務**: パフォーマンス改善・ビルド高速化・出力品質向上。計測 → ボトルネック特定 → 改善 → 再計測のサイクル
- **②適合度: 低** — 開発ワークフローの通常フローには組み込みにくい。パフォーマンス最適化は「必要になった時」にのみ実行される非定常タスク。計測ツールの前提（Python の cProfile, tracemalloc 等）がプロジェクト固有
- **③必要な修正点**: (a) テスト実行コマンドが未確定（TODO状態）(b) 「いつ最適化が必要か」の判断基準が未定義（目標値がタスクで指定される前提だが、目標値の設定方針がない）(c) 計測ツールの選定がプロジェクトに依存するため、汎用的なガイドラインが必要
- **④依存関係**: reviewer, feature_builder から最適化タスクを受ける。孤立度が高く、他ロールへの起票はほぼない

##### 7. documentarian（ドキュメント整備担当）
- **①現状の責務**: README・CHANGELOG・設計書・進捗サマリーの整備。全エージェントの作業内容集約と可視化
- **②適合度: 中** — ワークフローの終端に位置し、成果物のドキュメント化を担う。ただし「いつドキュメントを更新するか」のトリガーが L1 指示依存で、ワークフローへの自動組み込みが弱い
- **③必要な修正点**: (a) openspec 連携の TODO が未実装 (b) ワークフロー内での発動タイミング（リリース前？機能実装完了後？定期的？）の定義が必要 (c) docs/ 配下の設計書作成時のルール参照（design-doc.md, code-in-docs.md）が明示されていない
- **④依存関係**: 全ロールの作業内容を参照してドキュメント化する。他ロールへのタスク起票はない。ワークフローの終端ロール

#### ロール間依存関係の全体像

```
feature_builder ──起票──→ test_writer（テスト追加）
                ──起票──→ bug_fixer（既存バグ）
                ──起票──→ refactorer（リファクタリング）
                ──起票──→ optimizer（最適化）
                ──起票──→ documentarian（ドキュメント）

reviewer ──起票──→ bug_fixer（バグリスク）
         ──起票──→ refactorer（設計問題）
         ──起票──→ optimizer（パフォーマンス問題）

test_writer ──起票──→ bug_fixer（テストで発見したバグ）
            ──起票──→ refactorer（テスト不能な設計）

bug_fixer ──起票──→ refactorer（大規模修正が必要な場合）
```

**成果物**: T-001 分析結果（本ログに記録。T-004 で設計ドキュメントに統合予定）
**課題・気づき**: 全ロールに共通して openspec 連携の TODO が残っており、ISS-006（既起票済み）の対応が前提。テスト実行コマンドも全ロール未確定。

---

### [2026-03-01 10:30] タスクID: T-002
**状態**: 完了
**作業内容**:
- feature_builder と test_writer の分離TDD方式の有効性を4観点で評価

**評価結果**:

#### ①メリット
1. **独立検証の実現**: test_writer が feature_builder の実装を知らない状態でテストを書くことで、仕様ベースのテストが得られる。実装の内部構造に依存しない堅牢なテストになる
2. **専門性の活用**: test_writer はテスト設計（FIRST原則、AAAパターン、エッジケース発見）に特化でき、feature_builder は実装に集中できる
3. **品質ゲートの強化**: テストが実装者とは異なる視点で書かれるため、実装者のバイアスによるテスト漏れを防げる
4. **ロールの責務明確化**: 「テストを書く」と「実装する」が明確に分離され、各ロールのスコープ制御が容易になる
5. **コンテキスト分離**: サブエージェントのコンテキストウィンドウを効率的に使える。テスト作成と実装作成がそれぞれ独立したコンテキストで動作する

#### ②デメリット
1. **コンテキスト切替コスト**: test_writer → feature_builder 間でタスクを引き渡す際、仕様の解釈や完了条件の共有にオーバーヘッドが生じる
2. **コミュニケーション負荷**: テストが期待する振る舞いと実装の設計方針が乖離した場合、L1 を介した調整が必要になる
3. **フィードバックループの遅延**: 古典的TDD（Red → Green → Refactor）はテスト作成と実装を高速に往復するが、ロール分離すると往復の単位が大きくなり、フィードバックが遅くなる
4. **テスト設計の前提不足**: test_writer が仕様のみからテストを設計する場合、実装のアーキテクチャ（関数シグネチャ、モジュール構造）を知らないため、テストのインターフェースが実装と合わない可能性がある
5. **過剰な分離による非効率**: 単純な変更（1関数の追加等）でもロールを分離すると、タスク引き渡しのオーバーヘッドが実装時間を上回る

#### ③有効なケースと不要なケースの分類

**TDD分離が有効なケース:**
- 複雑なビジネスロジック（分岐・状態遷移が多い機能）
- セキュリティ要件が高い機能（認証・認可・暗号化）
- 外部API連携（仕様が明確で、モック・スタブが有効な領域）
- 既存コードの大規模改修（回帰テストの網羅性が重要）
- 複数の開発者が関わる機能（独立検証の価値が高い）

**TDD分離が不要なケース:**
- 単純な CRUD 操作の追加
- 1ファイル・1関数の軽微な変更
- ドキュメントのみの変更
- 設定ファイルの変更
- プロトタイプ・探索的実装（仕様が未確定で、テスト設計が困難）

#### ④推奨方針: 条件付き分離

**推奨: 条件付き分離方式**

- **デフォルト**: feature_builder が実装時に完了条件に対応するテストも記述する（現状の feature_builder の作業フローに沿う）
- **分離トリガー**: 以下の条件のいずれかに該当する場合、L1（またはdev_manager）が test_writer を別途起動する
  - タスクの複雑度が高い（分岐数が5以上、または複数モジュールにまたがる変更）
  - セキュリティ・信頼性要件が高い
  - 既存テストカバレッジが低い領域への変更
  - L1/reviewer が追加テストの必要性を判断した場合

**分離時のフロー案:**
1. test_writer が仕様ベースのテストを先に作成（Red）
2. feature_builder がテストを通す実装を作成（Green）
3. refactorer が必要に応じてリファクタリング（Refactor）
4. reviewer がレビュー

**根拠**: 常時分離はオーバーヘッドが大きく、不要なケースでの非効率が目立つ。一方で、重要な機能では独立検証の価値が高い。条件付き分離により、品質と効率のバランスを取れる。

**成果物**: T-002 評価結果（本ログに記録。T-004 で設計ドキュメントに統合予定）
**課題・気づき**: 分離トリガーの判断基準（複雑度の定量指標など）は詳細設計（フェーズ2）で具体化が必要

---

### [2026-03-01 10:50] タスクID: T-003
**状態**: 完了
**作業内容**:
- 開発ワークフローに必要だが未定義のロールを3つの検討対象について整理

**検討結果**:

#### ①設計者ロール（designer）

**必要性判断: 要検討**

**現状の設計責務の所在**:
- openspec 内に暗黙的に存在（spec 作成・delta 作成が設計行為に相当）
- feature_builder の「要件の理解」ステップが軽量な設計行為を含む
- reviewer の「設計」観点レビューが事後的な設計チェックを担う

**独立ロール化の論点**:
- **賛成**: 設計と実装の分離は責務の明確化につながる。特に openspec 連携が確定した後は、spec から実装タスクへの変換（タスク分解・インターフェース設計）を専門に行うロールが有用
- **反対**: 現状のリポジトリ規模では設計専任ロールはオーバーヘッドが大きい。feature_builder の「要件の理解」ステップで十分な場合が多い
- **結論**: openspec 開発ライフサイクルが確定するまでは独立ロール化を保留し、feature_builder の要件理解ステップを強化する方向で対応する。openspec 連携が確定した後に再評価する

**仮に必要となった場合の責務案**:
- spec（仕様）からタスクへの分解
- インターフェース設計（関数シグネチャ、モジュール構造）
- データモデル設計
- 設計ドキュメントの作成（docs/design/ 配下）
- 他ロールへの設計意図の伝達

#### ②開発マネージャーロール（dev_manager）

**必要性判断: 必要**

**施策管理 L1 との差異**:
- 施策管理 L1 は `dev-process-improvement/initiatives/` 配下の施策管理（提案・計画・ゲート判定）を担当
- 開発マネージャーは `src/`, `tests/`, `docs/` 配下のコード開発セッションのオーケストレーションを担当
- 活動ディレクトリ、対象ファイル、管理プロセスが異なる

**必要性の根拠**:
1. **タスクの分配**: 7つのロールへのタスク割り当て・優先順位付けを誰かが行う必要がある。common.md では「L1 がタスクを定義」とあるが、コード開発のコンテキストでは開発専門のマネージャーが適切
2. **ロール間調整**: reviewer の発見を bug_fixer/refactorer に振り分ける、test_writer と feature_builder の連携タイミングを判断するなど、ロール間のオーケストレーションが必要
3. **品質ゲート**: レビュー結果に基づく合否判定、差し戻しフローの制御
4. **進捗管理**: 各ロールの完了報告を受けて、次のロール起動を判断する

**責務案**:
- コード開発タスクの作成・分配（どのロールにどのタスクを割り当てるか）
- ロール間のオーケストレーション（起動順序・依存関係の管理）
- レビュー結果に基づく判断（合格→次工程、不合格→差し戻し先の決定）
- コード開発セッション全体の進捗管理と完了判定
- ブロッカー発生時のエスカレーション判断

**施策管理 L1 との連携**:
- 施策管理 L1 が `02_tasks.md` に「機能Xを実装せよ」と書く
- dev_manager がそのタスクを受けて、feature_builder, test_writer, reviewer 等への細分化・起動を行う
- dev_manager が完了報告を施策管理 L1 に返す

#### ③その他の不足ロール候補

**検討結果: 現時点では追加不要**

検討した候補:
- **CI/CD 管理ロール**: テスト実行・ビルド・デプロイの自動化を管理。現状ではテスト実行コマンドすら未確定のため時期尚早。将来的に必要になる可能性はあるが、dev_manager のサブタスクとして対応可能
- **セキュリティ専門ロール**: reviewer のセキュリティ観点レビューを独立させる。現状の reviewer のチェックリストで十分。大規模プロジェクトでは検討の余地あり
- **テストインフラロール**: テストフレームワークの設定・CI パイプラインの構築。optimizer の守備範囲に含めるか、dev_manager が管理するのが妥当

**成果物**: T-003 検討結果（本ログに記録。T-004 で設計ドキュメントに統合予定）
**課題・気づき**: designer ロールの要否は openspec 連携の確定（ISS-006）に依存する。dev_manager ロールは common.md の L1 概念を拡張する形で定義すべき

---

### [2026-03-01 11:10] タスクID: T-004
**状態**: 完了
**作業内容**:
- T-001〜T-003 の分析結果を統合し、`docs/design/dev-workflow-overview.md` を新規作成
- 含めた内容:
  1. mermaid 図を含むワークフロー全体像（ロール構成図、標準開発フロー、施策管理連携シーケンス図）
  2. 施策管理ワークフローとの差異説明（比較表、連携ポイント）
  3. ロール間データフロー（各ロールの入力/出力テーブル、情報受け渡し手段）
  4. T-001〜T-003 の分析結果サマリー（適合度テーブル、TDD評価、不足ロール要件、共通課題）
  5. 次フェーズへの引き継ぎ事項

**成果物**: `docs/design/dev-workflow-overview.md`
**課題・気づき**: 特になし。T-001〜T-003 の分析が十分だったため、統合は円滑に進んだ

---

### [2026-03-01 11:30] タスクID: T-005
**状態**: 完了
**作業内容**:
- `07_issues.md` を確認。未転記メモセクションにはテンプレートのコメントのみで、既存の課題メモはなし
- T-001〜T-004 の作業中に発見した課題・気づきを3件起票:
  1. 全ロール共通: テスト実行コマンドが未確定（知見）
  2. ロール間タスク起票の具体的手順・テンプレートが未定義（改善提案）
  3. dev_manager ロールの新規定義が必要（改善提案）
- 全3件について転記判断を実施:
  - 3件とも「転記不要」（本施策の後続施策またはフェーズ2で対応する施策内課題）
  - 施策をまたいで再発しうる課題に該当するものはなし（ISS-006 は既に CSV に起票済み）

**成果物**: `07_issues.md` に3件の課題メモを起票、全件に転記判断を付与
**課題・気づき**: なし

---

