# 改善施策提案: シナリオ別セッション運用フロー設計

## 背景・課題

施策「コード開発ワークフロー設計の探索」で、既存7ロール（planner, architect, implementer, reviewer, tester, documenter, debugger）を活用した開発ワークフローのロール間連携設計（セッション内部の動き）が完了した。しかし、以下の上位レイヤーの設計が不足している。

1. **人間のエントリーポイントが未定義**（知見#9）: 現在の設計では施策管理 L1 → dev_manager の指示系統を前提としているが、「開発フローは施策管理から独立し、人間が直接エントリーする」方針に変更された。人間が「やりたいこと」を入力したら適切なセッションが起動する仕組みが必要
2. **シナリオ別のセッション構成が未設計**（知見#10）: 「何をやりたいか」によって起動すべきセッション構成（どのロールをどう組み合わせるか）が異なるが、そのルーティングロジックが未定義
3. **レビュー・評価の深度設計が未決**: 開発セッション内での軽量レビュー（reviewer ロール起動）と、独立評価セッション（別セッションでのフルレビュー）の使い分け基準が必要

### 参照元

- `docs/design/dev-workflow-overview.md` — 概要設計（ロール互換性分析、TDD戦略、ロールギャップ分析）
- `docs/design/dev-workflow-detail.md` — 詳細設計（3シナリオ、ハブ&スポーク連携プロトコル、20のロール修正提案）
- `dev-process-improvement/initiatives/_archive/コード開発ワークフロー設計の探索/08_gate_review.md` — 知見#9, #10

## 目標

1. **セッションディスパッチャー/ルーターの設計**: 人間の意図を分類し、適切なセッション構成にルーティングするフローを定義する
2. **5シナリオの詳細セッションフロー設計**: 各シナリオにおけるロール構成・入出力・品質ゲート・分岐条件を mermaid 図付きで設計する
3. **ハイブリッドレビュー方式の基準策定**: 軽量レビューと独立評価の使い分け基準を定量的/チェックリスト形式で定義する
4. **dev_manager エントリーポイント再設計**: L1→dev_manager の結合を外し、人間→dev_manager の直接エントリーに変更する
5. **横断的関心事の設計**: セッション間の状態永続化・コンテキスト引き継ぎ・エラー回復を設計する
6. **既存設計ドキュメントとの統合マッピング**: 新規設計と既存2ドキュメントのデザインデルタを明示する

## スコープ

### やること

- セッション運用フロー全体設計（ライフサイクル・ディスパッチャー・エントリーポイント）
- 5シナリオの詳細セッションフロー設計（mermaid シーケンス図・ロール構成表・I/O仕様・分岐条件）
- ハイブリッドレビュー方式の仕様策定（判定基準テーブル）
- dev_manager エントリーポイント再設計（起動トリガー源の変更）
- 横断的関心事設計（状態永続化・コンテキスト引き継ぎ・エラー回復）
- 既存設計ドキュメントとのデザインデルタ作成

### やらないこと

- ロール定義ファイル（`roles/*.md`）の実装・修正 → 後続施策「コード開発ワークフロー・ロール定義の実装」で実施
- CI/CD パイプラインの設計・構築
- OpenSpec 設定変更
- dev_manager の内部責務変更（エントリーポイント＝起動トリガー源のみ変更、内部ロジックは不変）

## 期待される効果

- 人間が「やりたいこと」を入力するだけで、適切なセッション構成が自動的に決まる運用フローが確立される
- シナリオ別に最適化されたロール構成・フロー・品質ゲートが定義され、開発効率と品質のバランスが取れる
- 施策管理ワークフロー（dev-process-improvement）と開発ワークフローの責務分界が明確になる
- 後続施策「ロール定義の実装」の設計インプットが完備され、実装着手可能な状態になる

## リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| 5シナリオでスコープが膨張する | 中 | Phase 1 で共通フレームワークを確立し、各シナリオはテンプレート構造を共有する |
| 既存設計ドキュメントとの不整合が大きくなる | 高 | T-012 でデザインデルタ表を作成し、明示的に差分を管理する |
| シナリオ1（要件定義→設計）に既存ロールが不足する可能性 | 中 | 設計として不足を文書化し、実装は後続施策に委ねる |
| dev_manager 再設計の波及範囲が拡大する | 低 | エントリーポイント（起動トリガー源）のみ変更し、内部責務は不変と明記する |

## 壁打ちの背景

### 意思決定の記録

1. **成果物の配置先**: 新規 `docs/design/session-operation-flow.md` を先に作成し、既存2ドキュメントの記載修正は後で整合性を合わせる方針で合意。理由: 既存ドキュメントは施策管理と連携しており、まず新規成果物を完成させてからデルタを整理する方が安全
2. **dev_manager エントリーポイント再設計のスコープ**: 本施策に含める方針で合意。知見#9 の解消を本施策で行い、後続施策ではこの設計をインプットとしてロール定義を実装する
3. **レビュー方式**: ハイブリッド方式で合意済み（軽量レビュー＝開発セッション内 reviewer + 独立評価＝別セッション。日常は軽量、重大変更・リリース前・セキュリティ要件ありの場合は独立評価）

### 5シナリオの定義（壁打ちで合意）

| # | シナリオ | 概要 |
|---|---------|------|
| 1 | 要件定義〜設計 | ユーザーの要求を要件に落とし込み、設計ドキュメントを作成する |
| 2 | 実施計画作成〜開発実施（軽量レビュー込み） | 設計をもとに実施計画を立て、ロール分担で開発を実施する。セッション内で reviewer を起動して軽量レビューを行う |
| 3 | 独立評価（オプション） | 重大変更・リリース前に起動する独立した評価セッション。開発セッションとは別コンテキストで客観的に評価する |
| 4 | ドキュメント整合性 | 既存のドキュメントを実態（コード・設計・運用）と照合し、整合性を合わせる |
| 5 | リファクタリング・最適化 | コード品質改善・パフォーマンス最適化を行う |

## 備考・設計パターン

本施策は「設計のみ」の施策である。主要成果物は `docs/design/session-operation-flow.md` であり、ロール定義ファイルの実装は行わない。

設計の位置づけ:
- 既存 `dev-workflow-overview.md`（概要）+ `dev-workflow-detail.md`（詳細）= セッション内部のロール間連携設計
- 本施策 `session-operation-flow.md` = セッション外部のルーティング・ライフサイクル・エントリーポイント設計
- 3ドキュメントで開発ワークフロー設計の全体像をカバーする構成

---
**起票者**: L1
**起票日**: 2026-03-01
**ステータス**: 承認済
