# 分析: poc ロール定義の構造分析

**タスクID**: T-001
**作成日**: 2026-02-23
**分析対象**: `refs/ai-driven-development-poc/.claude/`

---

## 分析観点①: 各ロールの名称と責務

poc には 7 つのロールが定義されている。

| ロール名 | ファイル名 | 責務の要約 |
|---------|-----------|-----------|
| Feature Builder | `feature_builder.md` | 新機能の実装。タスクキューから機能タスクを選んでコードを書き、テストを通す |
| Bug Fixer | `bug_fixer.md` | 失敗テスト・既知バグの修正。最小差分での修正と回帰テストの追加が責務 |
| Reviewer | `reviewer.md` | 直近コミットの静的レビュー。問題を発見してタスクとして起票するが、自分では修正しない |
| Test Writer | `test_writer.md` | テストカバレッジの拡充とエッジケースの追加。コードの修正は行わない |
| Refactorer | `refactorer.md` | 重複コードの統合・DRY化・設計改善。振る舞いを変えずに内部品質を高める |
| Optimizer | `optimizer.md` | パフォーマンス改善。計測→ボトルネック特定→改善→計測のサイクルを回す |
| Documentarian | `documentarian.md` | README・CHANGELOG・進捗サマリーの整備。全エージェントのログを集約して可視化する |

各ロールは責務を厳密に分離しており、「やらないこと」セクションが各ファイルに明記されている。例えば Feature Builder はリファクタリングを禁止し、Reviewer は問題を発見しても自分で修正することを禁止している。

---

## 分析観点②: プロンプトの構成セクション

全 7 ロールに共通する構成パターンを以下に示す。

### 共通の見出し構造

```
# {ロール名} - {役割の一行説明}

## あなたの責務          ← 何をするロールか（1〜2文）
## 担当タスクディレクトリ  ← 監視対象と完了先のパス
## 作業の流れ            ← 1〜10程度のステップ（ロックからコミットまで）
  ### 1. タスク選定       ← bash コマンド例付き
  ### 2. ロック取得       ← protocol 参照または具体的な手順
  ### 3. 〜               ← ロール固有の作業（実装・バグ再現・レビューなど）
  ...
  ### N. 完了報告         ← ユーザーへの報告内容
## 成功条件              ← チェックリスト形式
## やらないこと（重要）   ← ロール外作業の明示的な禁止リスト
## トラブルシューティング  ← Q&A 形式の典型問題への対処
## 例: 〜の流れ           ← bash コマンドをまとめたエンドツーエンドの手順例
## 〜の心得              ← 箇条書きの行動原則（締めの節）
```

### ロール固有のセクション

| ロール | 固有セクション |
|-------|--------------|
| Bug Fixer | バグの再現・原因の分析・回帰テストの追加 |
| Reviewer | コードレビュー観点（セキュリティ・バグリスク・設計・パフォーマンス・可読性）、問題の分類（Critical/High/Medium/Low）、レビューのチェックリスト |
| Test Writer | 現状のカバレッジ確認、FIRST原則、AAAパターン、テストの種類（単体・統合・エッジケース） |
| Optimizer | 現状の計測（プロファイリング手法）、ボトルネックの特定、最適化後の計測（数値比較） |
| Documentarian | ドキュメントの種類（README・CHANGELOG・進捗サマリー）、各ドキュメントの更新フォーマット・テンプレート |

---

## 分析観点③: base_prompt.md との関係

### base_prompt.md の役割

`base_prompt.md` は「全エージェント共通の土台」であり、ロール別プロンプトとは明示的に分離されている。

**base_prompt.md が担当する内容:**
- プロジェクト構造（tasks/, locks/, logs/, done/, src/, tests/, ci/）
- 基本的な作業ループ（タスク選定→ロック取得→作業→テスト→コミット→ロック解放→完了報告）
- 全エージェントが従うべきプロトコルの参照指示（lock_protocol.md, commit_protocol.md, test_protocol.md）
- 進捗ログの自動記録の説明（post-commit フック）
- 禁止事項（ロール外作業・競合を引き起こす行為・既存テストを壊す変更・過度な変更・無限ループ）
- コミットメッセージの規約（`[{role}-{id}] {category}-{task_id}: {summary}` 形式）
- 環境変数による自己識別（AGENT_ROLE, AGENT_ID）
- エラー発生時の対応（エラー分類・ロック取得失敗・テスト失敗）

**ロール別プロンプト（roles/*.md）が担当する内容:**
- 担当タスクディレクトリの具体的なパス
- ロール固有の作業ステップとその詳細手順
- コミットメッセージの具体例（ロール名を含む）
- 成功条件のチェックリスト
- ロール外作業の明示的な禁止（「やらないこと」）
- トラブルシューティング（ロール固有の問題への対処）

### 分離の方式

base_prompt.md の末尾に以下の記述がある:

> このbase_promptに加えて、あなたのロール別プロンプト（`roles/{role}.md`）と3つのプロトコル（`protocols/*.md`）が提供されます。それらを読み、あなたの具体的な責務と作業手順を理解してから、タスクを開始してください。

つまり、エージェント起動時に **base_prompt.md + roles/{role}.md + protocols/*.md** の 3 層を組み合わせて使うアーキテクチャになっている。

**プロトコルファイル（protocols/*.md）の役割:**

| ファイル | 内容 |
|---------|------|
| `lock_protocol.md` | ロックファイルの命名規則・取得手順・解放手順・タイムアウト・コンフリクト解消ルール |
| `commit_protocol.md` | コミットメッセージ形式・カテゴリ一覧・push 前手順・コンフリクト解消ルール |
| `test_protocol.md` | テスト実行ルール（ci/run_fast.sh・ci/run_full.sh）（詳細は未読だが lock_protocol・commit_protocol から参照） |

ロール別プロンプト内では `protocols/lock_protocol.md に従ってロックを取得` のように参照を省略しているロールもあれば、feature_builder.md のように詳細な bash コマンドを展開しているロールもある。記述スタイルに一部の揺らぎがある。

---

## 分析観点④: ロール間の協調方法

### ロックによる排他制御

- `locks/{category}__{task_id}.lock` ファイルを Git にコミット・プッシュすることでロックを実現
- `git push` の成功/失敗でロック取得の成否を判定（先に push したエージェントがロック取得）
- コンフリクト発生時は後から来たエージェントが引き下がり、別のタスクを選ぶ

### タスクキューによる分業

- `tasks/{category}/` ディレクトリがタスクキュー。各ロールが担当カテゴリのタスクを自律的に選ぶ
- タスクの状態（open / done / blocked）をファイル内に記述することで状態を共有
- 完了タスクは `done/{category}/` へ移動することで「取りに来ない」仕組みを実現

### ロール間のタスク委譲

各ロールの「やらないこと」に、他ロールへの委譲パターンが記載されている。

| 発見者ロール | 問題の種類 | 委譲先 |
|------------|---------|-------|
| Feature Builder | 既存バグを発見 | Bug Fixer のタスクとして起票 |
| Feature Builder | パフォーマンス問題 | Optimizer のタスクとして起票 |
| Feature Builder | リファクタリングが必要 | Refactorer のタスクとして起票 |
| Bug Fixer | 大規模リファクタリングが必要 | Refactorer のタスクとして起票 |
| Reviewer | セキュリティ・バグリスク | Bug Fixer のタスクとして起票 |
| Reviewer | 重複コード・設計問題 | Refactorer のタスクとして起票 |
| Reviewer | パフォーマンス問題 | Optimizer のタスクとして起票 |
| Test Writer | バグを発見 | Bug Fixer のタスクとして起票 |

Reviewer はこの委譲の中心的な役割を果たしており、問題の発見と分類（Critical/High/Medium/Low）に特化している。

### 進捗の可視化

- Git の `post-commit` フックが `logs/{role}-{id}/progress.md` を自動更新
- Documentarian がログを集約して `logs/_summary.md` に進捗サマリーを作成
- エージェント自身が手動でログを更新する必要はない設計

---

## 分析サマリー

| 項目 | poc の設計方針 |
|-----|-------------|
| ロール数 | 7（機能実装・バグ修正・レビュー・テスト・リファクタリング・最適化・ドキュメント） |
| プロンプト構成 | base_prompt（共通土台）+ roles/*.md（ロール固有）+ protocols/*.md（手順書） の 3 層 |
| 排他制御 | Git push によるロックファイルの先取り |
| ロール間協調 | タスクキューへの起票で委譲、Reviewer が問題分類の中心を担う |
| 進捗記録 | post-commit フックによる自動記録（エージェントは手動更新不要） |
| 最小動作単位 | 1 セッション = 1 タスク（無限ループ禁止） |
