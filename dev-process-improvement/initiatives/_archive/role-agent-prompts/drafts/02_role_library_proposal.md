# 提案: ロールライブラリのディレクトリ構成と必要ロールリスト

**タスクID**: T-002
**作成日**: 2026-02-23
**前提資料**: `drafts/01_poc_role_analysis.md`

---

## 1. 提案するディレクトリ構成（ツリー形式）

```
ai-driven-dev-patterns/          # リポジトリルート
└── roles/                       # ロール定義ライブラリ（本提案の整備対象）
    ├── _base/
    │   └── common.md            # 全ロール共通の土台（base_prompt 相当）
    ├── feature_builder.md       # 機能実装担当
    ├── bug_fixer.md             # バグ修正担当
    ├── reviewer.md              # レビュー担当
    ├── test_writer.md           # テスト整備担当
    ├── refactorer.md            # リファクタリング担当
    ├── optimizer.md             # 最適化担当
    └── documentarian.md         # ドキュメント整備担当
```

### 設計上の判断

- `roles/` をリポジトリルート直下に配置する。`docs/` や `.claude/` とは異なる用途（エージェント実行プロンプト）であるため独立させる。
- 共通ファイルは `roles/_base/common.md` に集約する（詳細は観点④を参照）。
- ロールファイルのファイル名は poc に合わせてスネークケース（`feature_builder.md` など）を踏襲する。
- プロトコルファイル（lock_protocol, commit_protocol, test_protocol）は、本リポジトリでは Gitベースの並列排他制御を前提とせず、当面は roles/ 内に含めない（観点④で考察）。

---

## 2. 必要ロールリスト

T-001 の分析を踏まえ、本リポジトリで用意すべきロールは以下の 7 つ。poc と同じセットを基本とする。

| # | ロール名 | ファイル | 責務の一言説明 |
|---|---------|---------|--------------|
| 1 | Feature Builder | `feature_builder.md` | タスク仕様に基づき新機能を実装し、テストを通す |
| 2 | Bug Fixer | `bug_fixer.md` | バグを再現・原因分析し、最小差分で修正して回帰テストを追加する |
| 3 | Reviewer | `reviewer.md` | 変更済みコードを静的にレビューし、問題を分類してタスクとして起票する |
| 4 | Test Writer | `test_writer.md` | テストカバレッジを拡充し、エッジケースを追加する |
| 5 | Refactorer | `refactorer.md` | 振る舞いを変えずに重複排除・設計改善・DRY化を行う |
| 6 | Optimizer | `optimizer.md` | 計測でボトルネックを特定し、パフォーマンスを改善する |
| 7 | Documentarian | `documentarian.md` | 設計書・README・変更履歴・進捗サマリーを整備する |

### 補足: 本リポジトリ固有の要件

本リポジトリ（ai-driven-dev-patterns）はアプリ開発パターンテンプレートであり、`openspec/` を中心とした仕様駆動開発フローを持つ。そのため以下の点が poc との差異になる見込みである（フェーズ2 で実装時に要検討）。

- **Feature Builder**: タスクキューのパスが `tasks/features/` ではなく `openspec/changes/*/tasks.md` になる可能性
- **Documentarian**: 管理対象が README/CHANGELOG に加えて `openspec/specs/` のマージ操作も含まれる可能性
- **Reviewer**: レビュー観点として openspec の仕様との整合性チェックが追加される可能性

---

## 3. poc からそのまま転用できるロールと、改修が必要なロールの区別

### 転用可能（内容の変更が少ない）

以下のロールは責務・作業手順が汎用的であり、パス参照を書き換える程度の軽微な修正で転用できると判断する。

| ロール | 転用可能な理由 |
|-------|-------------|
| Bug Fixer | 再現→分析→最小差分修正→回帰テストの流れはプロジェクト依存度が低い |
| Refactorer | 振る舞いを変えないリファクタリングの手順はプロジェクト非依存 |
| Optimizer | 計測→ボトルネック特定→改善→計測のサイクルはプロジェクト非依存 |
| Test Writer | テスト作成の原則（FIRST, AAA, エッジケース）はプロジェクト非依存 |

**必要な修正内容**: ci スクリプトのパス（`./ci/run_fast.sh` 等）を本リポジトリに合わせて変更する。

### 改修が必要（内容の見直しが必要）

以下のロールは poc 固有の前提が多く、本リポジトリのコンテキストに合わせた改修が必要。

| ロール | 改修が必要な理由 |
|-------|--------------|
| Feature Builder | タスクキューのパス（`tasks/features/`）が本リポジトリの構造（`openspec/changes/`）に対応していない。タスクの選び方・完了の定義が異なる可能性が高い |
| Reviewer | poc ではコミット履歴をレビュー対象にしているが、本リポジトリでは openspec 仕様との整合性チェックも対象になりうる |
| Documentarian | 管理ドキュメントの種類と更新サイクルが異なる（`logs/_summary.md` ではなく openspec の変更サイクルと連動する可能性） |

### ロックプロトコル（protocols/）の扱い

poc では複数エージェントの並列実行を前提として `locks/` + Git push によるロックプロトコルを使っている。

本リポジトリの想定アーキテクチャ（マネージャーセッションがサブエージェントを順次または並列に呼び出す）では、ロックの必要性は呼び出し方に依存する。フェーズ2 の設計段階で決定すべき事項のため、現時点では protocols/ のファイルを roles/ に含めない。

---

## 4. base_prompt 相当の共通ファイルを設けるかどうかの考察

### poc の設計

poc では `base_prompt.md` が「全エージェント共通の土台」として機能し、ロール別プロンプトとは明示的に分離されている。共通部分には以下が含まれる。

- プロジェクト構造の説明
- 基本的な作業ループ（8 ステップ）
- 必須プロトコルへの参照
- 進捗ログの自動記録の仕組み
- 禁止事項（5項目）
- コミットメッセージの規約
- 自己識別の方法

### 本リポジトリでの判断

**共通ファイル（`roles/_base/common.md`）を設けることを推奨する。**

理由は以下の通り。

1. **重複の排除**: 7 ロール全てに「コミットメッセージの規約」「禁止事項」「基本的な作業ループ」を繰り返し記述するとメンテナンスコストが高くなる
2. **一貫性の確保**: 「ロール外作業の禁止」「テストを通してからコミット」などの原則はロール間で一貫していなければならない
3. **カスタマイズ性**: 本リポジトリ固有の要件（openspec との連携、CLAUDE.md のルールなど）を共通ファイルに書けば全ロールに反映できる

### 共通ファイルに含めるべき内容（案）

```
roles/_base/common.md の構成案

1. このリポジトリでのエージェントの役割
   - 想定アーキテクチャ（マネージャー→サブエージェント）の説明
   - ロールの組み合わせ方（プロジェクトに応じて選択）

2. リポジトリ構造
   - src/, tests/, openspec/, docs/ の役割
   - タスクの発生元（openspec/changes/*/tasks.md など）

3. 基本的な作業ループ
   - タスク確認→実装→テスト→コミット→完了報告の骨格

4. 禁止事項（共通）
   - ロール外作業の禁止
   - テストが失敗した状態でのコミット禁止
   - 過度な変更の禁止

5. コミットの規約
   - メッセージ形式（poc の形式を踏襲するか、または CLAUDE.md の形式に揃えるか要検討）

6. 完了報告の形式
   - ユーザーへの報告フォーマット
```

### 留意点

- ロール別ファイルでは `roles/_base/common.md` を読んでから作業を開始することをファイル冒頭に明記する
- マネージャーセッションがサブエージェントを呼び出す際に、共通ファイルとロール別ファイルの両方を渡す運用にする

---

## サマリー

| 項目 | 提案 |
|-----|------|
| ディレクトリ配置 | リポジトリルート直下に `roles/` を新設 |
| ロール数 | 7（poc と同セット） |
| 共通ファイル | `roles/_base/common.md` を設ける（推奨） |
| 転用可能ロール | Bug Fixer, Refactorer, Optimizer, Test Writer（パス修正のみ） |
| 改修必要ロール | Feature Builder, Reviewer, Documentarian（コンテキスト差異あり） |
| プロトコルファイル | フェーズ2 の設計段階で必要性を判断、現時点は含めない |
