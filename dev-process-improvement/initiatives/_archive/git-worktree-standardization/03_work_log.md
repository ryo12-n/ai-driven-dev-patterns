# 作業履歴: git worktree によるClaude並列開発の標準化検討

## 壁打ちフェーズ [2026-02-25 14:16]

### 理解のサマリー
- タスクの目的: Claude Code の `isolation: "worktree"` 機能の仕様・制約を調査し、既存のロックベース方式との比較を行い、L1/L2ワークフローへの影響を分析した上で、ガイドライン文書を作成する
- スコープ: フェーズ1の全タスク（T-001〜T-005）。調査・ガイドライン文書作成まで。CLAUDE.md やルールファイルへの組み込みは行わない
- 完了条件: ガイドライン文書（`docs/git-worktree-guideline.md`）が7つのセクションを含む形で作成され、作業履歴・レポート・課題管理が完了していること

### 前提条件チェック
- [x] 依存タスクの完了状態: なし（フェーズ1の最初のタスク群）
- [x] 必要ツール・コマンドの利用可否: 確認済み（Web検索、ファイル読み書き）
- [x] 環境の準備状況（ファイル・ディレクトリの存在等）: 確認済み
  - `refs/ai-driven-development-poc/` が存在し、ロックベース方式の参照資料が利用可能
  - `docs/workflow.md`、`.claude/rules/` が存在し、L1/L2ワークフロー分析が可能
  - `initiatives/coordination-protocol/00_proposal.md` が存在し、接続点の整理が可能
  - `プロセス改善_課題管理.csv` が存在し、CSV転記が可能
  - ブランチ `claude/standardize-git-worktree-tdyf3` にチェックアウト済み

### 不明点・確認事項
なし

### L1 確認結果
確認事項なし：実施開始

---

## 実施計画サマリ

以下の順序でタスクを実施する:

1. **T-001**: Web情報から Claude Code の worktree 機能を調査（公式ドキュメント + コミュニティ情報）
2. **T-002**: `refs/ai-driven-development-poc/` のロックベース方式を分析し、worktree方式と比較
3. **T-003**: `docs/workflow.md`・`.claude/rules/` を参照し、worktree導入時の影響を分析
4. **T-004**: 上記調査結果を統合し `docs/git-worktree-guideline.md` を作成
5. **T-005**: `07_issues.md` の課題確認と CSV 転記

---

## 作業ログ

### [2026-02-25 14:16] タスクID: T-001
**状態**: 完了
**作業内容**:
- Claude Code 公式ドキュメント（code.claude.com/docs/en/common-workflows、code.claude.com/docs/en/sub-agents）を調査
- Web検索で最新の worktree 関連情報を収集（Anthropic 公式、DEV Community、各種技術ブログ）
- 以下の調査観点について整理:

**調査結果**:

#### ① worktree が作成・削除されるタイミング

**CLI レベル（`--worktree` フラグ）:**
- `claude --worktree <名前>` または `claude -w <名前>` で起動時に worktree が作成される
- 名前を省略すると自動生成される（例: `bright-running-fox`）
- worktree は `<リポジトリ>/.claude/worktrees/<名前>/` に作成される
- ブランチ名は `worktree-<名前>` となり、デフォルトリモートブランチから分岐する
- セッション中に「work in a worktree」と指示することでも作成可能

**サブエージェントレベル（`isolation: "worktree"`）:**
- カスタムサブエージェントの YAML frontmatter に `isolation: worktree` を設定
- サブエージェントが Task ツールで起動されるたびに一時的な worktree が自動作成される
- サブエージェント終了時に変更がなければ自動クリーンアップされる

#### ② サブエージェントが変更を加えた場合のブランチ・パスの返却方法

- 各サブエージェントは独自のブランチで作業する
- リードオーケストレーターはメインの worktree で実行される
- 各ワーカーは `.claude/worktrees/<ワーカー名>/` の別ディレクトリで実行される
- ワーカーが完了すると、変更はそのブランチにコミットされる
- リードエージェントが結果をマージする
- 2つのワーカーが同じファイルに書き込んだ場合、通常の git マージコンフリクトとして表面化し、git ツールで解決可能

#### ③ 変更がない場合の自動クリーンアップ

- **変更なし**: worktree とそのブランチは自動的に削除される
- **変更またはコミットあり**: Claude が保持するか削除するかをユーザーに確認する
  - 保持: ディレクトリとブランチが維持され、後で戻れる
  - 削除: worktree ディレクトリとブランチが削除され、未コミットの変更とコミットがすべて破棄される

#### ④ 親プロセスとの関係（コンテキスト共有の有無）

- サブエージェントは独自のコンテキストウィンドウで実行される（カスタムシステムプロンプト、特定のツールアクセス、独立した権限）
- サブエージェントはメインの会話のシステムプロンプトを受け取らず、自身の frontmatter で定義されたシステムプロンプトのみを受け取る
- サブエージェントは他のサブエージェントを起動できない（ネスト不可）
- パーミッションコンテキストはメインの会話から継承されるが、モードはオーバーライド可能
- サブエージェントのトランスクリプトはメインの会話とは別ファイルに保存される
- メイン会話のコンパクション時にサブエージェントのトランスクリプトは影響を受けない

#### ⑤ 既知の制約・制限事項

1. **パフォーマンスオーバーヘッド**: 各 worktree はリポジトリの完全なファイルシステムコピー。小規模リポジトリでは高速だが、大規模モノレポでは無視できないコスト
2. **環境初期化が必要**: 新しい worktree ごとに開発環境のセットアップが必要（npm install、仮想環境構築など）
3. **書き込み並列化でのみ有用**: 組み込みサブエージェント（Explore, Plan）は読み取り専用で隔離不要。書き込み並列化がある場合にのみオーバーヘッドが正当化される
4. **ファイルパスの監査が必要**: worktree 移行時、各エージェントが触れるファイルパスをすべて監査してコンフリクトの可能性を特定する必要がある
5. **サブエージェントはサブエージェントを起動できない**: ネストされた委任が必要な場合はスキルまたはメイン会話からのチェーンを使用する
6. **非 git VCS サポート**: SVN、Perforce、Mercurial などの場合は `WorktreeCreate` と `WorktreeRemove` フックの設定が必要
7. **`.claude/worktrees/` の .gitignore 追加推奨**: worktree の内容がメインリポジトリの未追跡ファイルとして表示されるのを防ぐため

**成果物**: 上記の調査結果（本ログ内）
**課題・気づき**: Claude Code の worktree 機能は成熟しており、公式ドキュメントで十分な情報が取得できた。不明点は少ない。

---

### [2026-02-25 14:16] タスクID: T-002
**状態**: 完了
**作業内容**:
- `refs/ai-driven-development-poc/` の README.md、docs/reference.md、.claude/protocols/lock_protocol.md を精読
- ロックベース方式の仕組みと設計思想を分析
- worktree 方式との比較ポイントを整理

**分析結果**:

#### ① ロックベース方式のメリット・デメリット

**メリット:**
- **シンプルなメカニズム**: テキストファイル（`.lock`）の作成・削除のみで排他制御を実現
- **可視性が高い**: `locks/` ディレクトリを見るだけで誰が何を作業中かわかる
- **Git 経由の同期**: push/pull で自然にロック状態が共有される（追加インフラ不要）
- **粒度の柔軟性**: タスク単位・ファイル単位など、ロック対象の粒度を自由に設定可能
- **リポジトリは単一**: 全エージェントが同じ作業ディレクトリを共有するため、環境のセットアップコストが低い

**デメリット:**
- **ファイル競合のリスク**: ロック粒度がタスク単位の場合、同じファイルを複数タスクが編集する可能性がある
- **デッドロックのリスク**: 複数のロックを必要とするタスクがある場合にデッドロックの可能性
- **手動介入が必要**: 長時間ロック（エージェント停止時など）は人間が手動で解除する必要がある
- **プロトコル遵守に依存**: エージェントがロックプロトコルを正しく守ることが前提（書き忘れ・削除忘れのリスク）
- **push コンフリクト**: ロック取得自体に git push が必要で、ネットワーク依存

#### ② worktree 方式との使い分け基準

| 比較軸 | ロックベース方式 | worktree 方式 |
|--------|----------------|--------------|
| **隔離レベル** | 論理的（ルールによる排他制御） | 物理的（別ディレクトリ・別ブランチ） |
| **ファイル競合** | プロトコル違反時に発生しうる | 構造的に発生しない（マージ時に検出） |
| **環境コスト** | 低い（単一ディレクトリ） | 高い（worktree ごとに環境セットアップ） |
| **適するシナリオ** | 同一リポジトリ内でタスクが明確に分離、tmux 並列、外部プロセス並列 | Claude Code のサブエージェント並列、独立性の高いタスク |
| **実装の複雑さ** | ロックプロトコルの策定・遵守が必要 | git worktree の標準機能で自動管理 |
| **マージ方式** | 同一ブランチに直接 push | ブランチ間マージ |
| **外部ツール依存** | なし（テキストファイルのみ） | git worktree コマンド、Claude Code の worktree サポート |
| **スケーラビリティ** | エージェント数に比例してロック競合リスク増加 | エージェント数に比例してディスク使用量増加 |

**使い分け基準:**
- **worktree を使うべき場面**: Claude Code のサブエージェント並列実行、同じファイルを複数エージェントが編集する可能性がある場合、コンフリクトの事後解決が許容される場合
- **ロックベースを使うべき場面**: 外部プロセス（tmux 並列）でのエージェント並列、タスク間のファイル依存が明確に分離されている場合、リアルタイムの排他制御が必要な場合

#### ③ 両方式を併用するケースの有無

- **併用は可能だが限定的**: worktree で物理的に隔離した上で、共有リソース（データベース、外部API等）のアクセスにロックを使うケース
- **本リポジトリのコンテキストでは**: 現時点では文書のみを扱うため併用の必要性は低い。将来コード開発を並列化する場合に検討の余地がある
- **協調プロトコル施策との関係**: `initiatives/coordination-protocol/` でロック・コミット・テストのプロトコルを定義予定。worktree 上でも共有リソースへのアクセス時にはロックプロトコルが必要になる可能性がある

**成果物**: 上記の比較分析（本ログ内）
**課題・気づき**: 両方式は排他的ではなく補完的。レイヤーが異なる（worktree = インフラ隔離、ロック = 論理的排他制御）。

---

### [2026-02-25 14:16] タスクID: T-003
**状態**: 完了
**作業内容**:
- `docs/workflow.md` を精読し、現在の L1/L2 ワークフロー構造を把握
- `.claude/rules/l1-manager.md`、`.claude/rules/l2-worker.md`、`.claude/rules/l2-evaluator.md` を精読
- worktree 導入時の影響箇所を分析

**分析結果**:

#### ① 現在 L2 を順次起動している理由と、worktree で並列化した場合の影響

**現在の順次起動の理由:**
- L1 が L2-worker を Task ツールでサブエージェントとして起動し、完了を待ってから L2-evaluator を起動する設計
- L2-worker が `03_work_log.md`、`04_work_report.md` を作成した後に、L2-evaluator がそれを評価する依存関係がある
- ファイル所有権ルールにより、L2-worker と L2-evaluator の担当ファイルが分離されている

**worktree で並列化した場合の影響:**
- L2-worker と L2-evaluator の並列化は依存関係上不可能（evaluator は worker の成果物を評価するため）
- **複数の L2-worker の並列化は検討可能**: 異なるタスクを担当する複数の L2-worker を worktree で隔離して並列実行
- ただし、`03_work_log.md` や `07_issues.md` への同時書き込みが発生するため、マージ時のコンフリクト解決が必要

#### ② ファイル所有権ルール（L1/L2 の担当ファイル分離）が worktree でどう変わるか

**現在のファイル所有権:**
| ファイル | L1 | L2(実施) | L2(評価) |
|---------|-----|---------|---------|
| 00_proposal.md | 作成・編集 | 読取 | 読取 |
| 01_plan.md | 作成・編集 | 読取 | 読取 |
| 02_tasks.md | 作成・編集 | チェック更新可 | 読取 |
| 03_work_log.md | 読取 | 作成・編集 | 読取 |
| 04_work_report.md | 読取 | 作成・編集 | 読取 |
| 07_issues.md | 転記判断 | 一時メモ起票 | 一時メモ起票 |

**worktree 導入時の変化:**
- worktree 上ではファイル所有権は物理的に保証される（各 worktree が独立したファイルシステム）
- ただし、マージ時にコンフリクトが発生する可能性がある（特に `07_issues.md` は worker と evaluator 双方が書き込み）
- **複数 L2-worker 並列の場合**: 各 worker が独自の worktree で `03_work_log.md` に書き込むと、マージ時にコンフリクトが発生する。ファイル分割（worker ごとの個別ログファイル）や、構造化された追記プロトコルが必要

#### ③ ワークフロー変更が必要になるポイントの一覧

| # | 影響箇所 | 変更の内容 | 優先度 |
|---|---------|-----------|-------|
| 1 | L1 のサブエージェント起動方式 | Task ツール呼び出し時に `isolation: worktree` を指定する仕組みの追加 | 高 |
| 2 | 作業ログ（03_work_log.md）の構造 | 複数 worker 並列時のマージ戦略の定義（ファイル分割 or 追記プロトコル） | 高 |
| 3 | 課題メモ（07_issues.md）の構造 | 複数 worker/evaluator 並列時のマージ戦略の定義 | 中 |
| 4 | タスクリスト（02_tasks.md）のステータス更新 | 複数 worker が同時にチェックボックスを更新する場合の競合回避 | 中 |
| 5 | L1 の成果物確認フロー | 複数 worktree からのマージ後に成果物を確認するフローの追加 | 中 |
| 6 | .gitignore の更新 | `.claude/worktrees/` の追加 | 低 |
| 7 | workflow.md の更新 | worktree 並列パターンの記載追加 | 低（本施策スコープ外） |

**成果物**: 上記の影響分析（本ログ内）
**課題・気づき**: 現在の L1/L2 ワークフローは順次実行を前提とした設計。worktree 導入で並列化する場合、ファイル構造と書き込みプロトコルの再設計が必要。ただし、これは本施策のスコープ（ガイドライン作成）には含まれず、将来の施策で検討すべき事項。

---

### [2026-02-25 14:16] タスクID: T-004
**状態**: 完了
**作業内容**:
- T-001〜T-003 の調査結果を統合し、`dev-process-improvement/docs/git-worktree-guideline.md` を作成
- 7つのセクション（概要、利用判断基準、ロックベース方式との比較、L1/L2ワークフローとの関係、将来の拡張方針、協調プロトコル施策との接続点、制約・注意事項）を含む

**成果物**: `dev-process-improvement/docs/git-worktree-guideline.md`
**課題・気づき**: なし

---

### [2026-02-25 14:16] タスクID: T-005
**状態**: 完了
**作業内容**:
- `07_issues.md` の未転記課題を確認
- 施策をまたぐ課題の有無を判定
- 作業中に発見した課題を起票・転記判定

**結果**: 作業中に施策をまたぐ課題は発見されなかった。`07_issues.md` に未転記メモなし。
**成果物**: `07_issues.md` 更新済み
**課題・気づき**: なし
