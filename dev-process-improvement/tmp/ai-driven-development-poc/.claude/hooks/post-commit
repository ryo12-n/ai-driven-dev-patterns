#!/bin/bash

# post-commit - é€²æ—ãƒ­ã‚°è‡ªå‹•è¨˜éŒ²ãƒ•ãƒƒã‚¯

# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
COMMIT_MSG=$(git log -1 --pretty=%B)

# ãƒ­ãƒ¼ãƒ«åã®æŠ½å‡ºï¼ˆ[role-id] ã®å½¢å¼ï¼‰
if [[ "$COMMIT_MSG" =~ ^\[([a-z_]+-[A-Za-z0-9]+)\] ]]; then
  AGENT="${BASH_REMATCH[1]}"
else
  # ãƒ­ãƒ¼ãƒ«åãŒãªã„å ´åˆã¯å‡¦ç†ã—ãªã„ï¼ˆäººé–“ã®ã‚³ãƒŸãƒƒãƒˆï¼‰
  exit 0
fi

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
LOGS_DIR="logs/$AGENT"
mkdir -p "$LOGS_DIR"
PROGRESS_FILE="$LOGS_DIR/progress.md"

# ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥
COMMIT_HASH=$(git log -1 --pretty=%h)

# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ1è¡Œç›®ï¼‰
COMMIT_SUMMARY=$(git log -1 --pretty=%s)

# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆè©³ç´°ï¼‰
COMMIT_DETAILS=$(git log -1 --pretty=%b)

# å¤‰æ›´è¦æ¨¡ï¼ˆ+/-è¡Œæ•°ï¼‰
STATS=$(git diff --shortstat HEAD~1 HEAD 2>/dev/null || echo "")

# å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

# ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
TIMESTAMP=$(date -Iseconds)

# é€²æ—ãƒ­ã‚°ã«è¿½è¨˜
{
  echo ""
  echo "---"
  echo "### $TIMESTAMP"
  echo "- **commit**: \`$COMMIT_HASH\`"
  echo "- **message**: $COMMIT_SUMMARY"

  if [ -n "$COMMIT_DETAILS" ]; then
    echo "- **details**:"
    echo "$COMMIT_DETAILS" | sed 's/^/  /'
  fi

  if [ -n "$STATS" ]; then
    echo "- **å¤‰æ›´è¦æ¨¡**: $STATS"
  fi

  if [ -n "$CHANGED_FILES" ]; then
    echo "- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**:"
    echo "$CHANGED_FILES" | sed 's/^/  - /'
  fi

  # ã‚¿ã‚¹ã‚¯å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã®æ¤œå‡º
  if echo "$CHANGED_FILES" | grep -q "^done/"; then
    COMPLETED_TASK=$(echo "$CHANGED_FILES" | grep "^done/" | head -n 1)
    echo "- ðŸŽ‰ **ã‚¿ã‚¹ã‚¯å®Œäº†**: $COMPLETED_TASK"
  fi

  # ãƒ­ãƒƒã‚¯æ“ä½œã®æ¤œå‡º
  if echo "$CHANGED_FILES" | grep -q "^locks/.*\.lock$"; then
    if git diff --name-status HEAD~1 HEAD | grep -q "^A.*locks/.*\.lock$"; then
      LOCK_FILE=$(git diff --name-status HEAD~1 HEAD | grep "^A.*locks/" | cut -f2)
      echo "- ðŸ”’ **ãƒ­ãƒƒã‚¯å–å¾—**: $LOCK_FILE"
    fi
    if git diff --name-status HEAD~1 HEAD | grep -q "^D.*locks/.*\.lock$"; then
      LOCK_FILE=$(git diff --name-status HEAD~1 HEAD | grep "^D.*locks/" | cut -f2)
      echo "- ðŸ”“ **ãƒ­ãƒƒã‚¯è§£æ”¾**: $LOCK_FILE"
    fi
  fi

} >> "$PROGRESS_FILE"

# Git ã«è¿½åŠ ï¼ˆæ¬¡å›žã®ã‚³ãƒŸãƒƒãƒˆã§è¨˜éŒ²ã•ã‚Œã‚‹ï¼‰
git add "$PROGRESS_FILE" 2>/dev/null || true

exit 0
