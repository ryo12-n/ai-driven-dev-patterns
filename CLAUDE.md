# CLAUDE.md

<!-- このリポジトリでClaude Codeを使う際の共通ルール・前提を記載する -->
<!-- 例: 設計書の書き方ルール、コード禁止ポリシー、openspec参照指示など -->

## 壁打ち・相互理解確認ルール

### 適用対象

以下に該当する「複雑なタスク」にのみ適用する。

- 設計・アーキテクチャの判断を伴う作業
- 複数ファイルにまたがる変更
- 要件が曖昧・解釈が複数ありうる依頼
- 仕様書・ドキュメントの新規作成・大幅改訂

単純な修正（誤字修正・1箇所の変更・明確な指示）は確認フェーズを省略して即実行してよい。

### タスク受領時の確認フェーズ

複雑なタスクと判断した場合、実装に着手する前に以下を提示する。

1. **理解のサマリー** — タスクの目的・スコープ・完了条件を自分の言葉でまとめる
2. **不明点の列挙** — 曖昧な箇所や判断が必要な選択肢を箇条書きで質問する

### 確認の定型表現（例）

- 「〜という理解で合っていますか？」
- 「〜と〜のどちらを意図していますか？」
- 「スコープは〜までで良いですか？」

### 柔軟性

ユーザーが「確認不要、すぐ進めて」と明示した場合は確認フェーズをスキップして実行してよい。

### 実行中のチェックイン

複数フェーズにわたる作業は、フェーズ境界で進捗を共有し、想定外の判断が必要になったら都度確認する。
途中でうまくいかなくなったら、無理に進めずすぐに立ち止まって再計画する。

### 実行後の確認

完了後は結果のサマリーを提示し、意図と一致しているか確認する。

---

## upstream 同期ポリシー

本リポジトリは **外部リポジトリ(upstream)を社内リポジトリ(origin)へ疑似フォーク**して運用している。
upstream の最新変更を取り込む際、以下のディレクトリは **origin 固有の作業実績** であるため、upstream の変更で上書きしてはならない。

### 保護対象ディレクトリ（upstream から同期しない）

- `dev-process-improvement/backlog/`
- `dev-process-improvement/inbox/`
- `dev-process-improvement/initiatives/`
- `dev-process-improvement/triage/`

upstream merge を実施する際は、必ずこれら4ディレクトリを保護すること。
詳細な手順・スクリプトの使い方は `.claude/rules/sync.md` を参照すること。

---

## OpenSpec 編集上の注意

`openspec/config.yaml` を直接編集するときは以下に注意すること。

- `rules:` セクションの文字列値に日本語が含まれる場合はシングルクォートで囲むこと
  - 例: `- '日本語のルール文字列'`（ダブルクォートは YAML パースエラーになる場合がある）

---

## サブエージェント戦略

- メインのコンテキストウィンドウをクリーンに保つためにサブエージェントを積極的に活用する
- リサーチ・調査・並列分析はサブエージェントに任せる
- 複雑な問題には、サブエージェントを使ってより多くの計算リソースを投入する
- 集中して実行するために、サブエージェント1つにつき1タスクを割り当てる

---

## 自己改善ループ

- ユーザーから修正を受けたパターンや協働スタイルの気づきは `dev-process-improvement/docs/collab-log.md` に記録する
- 同じミスを繰り返さないように、気づきをルール・ドキュメントに反映する
- セッション開始時に、そのプロジェクトに関連する collab-log のエントリをレビューする

---

## 完了前検証

- 動作を証明できるまで、タスクを完了とマークしない
- 必要に応じてメインブランチと自分の変更の差分を確認する
- 「スタッフエンジニアはこれを承認するか？」と自問する
- テストを実行し、ログを確認し、正しく動作することを示す

---

## 自律的なバグ修正

- バグレポートを受けたら、手取り足取り教えてもらわずにそのまま修正する
- ログ・エラー・失敗しているテストを見て、自分で解決する
- ユーザーのコンテキスト切り替えをゼロにする
- 言われなくても、失敗しているCIテストを修正しに行く

---

## タスク管理

1. **まず計画を立てる**: チェック可能な項目として計画を書く
2. **計画を確認する**: 実装を開始する前に確認する
3. **進捗を記録する**: 完了した項目を随時マークしていく
4. **変更を説明する**: 各ステップで高レベルのサマリーを提供する
5. **結果をドキュメント化する**: 作業ログにレビューセクションを追加する

---

## コア原則

- **シンプル第一**: すべての変更をできる限りシンプルにする。影響するコードを最小限にする。
- **手を抜かない**: 根本原因を見つける。一時的な修正は避ける。シニアエンジニアの水準を保つ。
- **影響を最小化する**: 変更は必要な箇所のみにとどめる。バグを新たに引き込まない。
